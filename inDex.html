<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriVision AI - Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--background); color: var(--text); }
        .app { max-width: 420px; margin: 0 auto; background: var(--surface); min-height: 100vh; box-shadow: 0 0 50px rgba(0,0,0,0.1); }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }

        /* Auth */
        .auth-screen { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 40px 24px; display: flex; flex-direction: column; justify-content: center; min-height: 100vh; }
        .auth-logo { text-align: center; margin-bottom: 48px; }
        .auth-logo .icon { font-size: 80px; }
        .auth-logo h1 { color: white; font-size: 32px; margin: 16px 0 8px; }
        .auth-logo p { color: rgba(255,255,255,0.9); }
        .auth-card { background: white; border-radius: 24px; padding: 32px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .auth-card h2 { font-size: 24px; margin-bottom: 24px; text-align: center; }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
        .form-group.error input { border-color: var(--danger); }
        .form-error { color: var(--danger); font-size: 13px; margin-top: 4px; display: none; }
        .form-group.error .form-error { display: block; }

        /* Buttons */
        .btn { padding: 16px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16,185,129,0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: white; color: var(--text); border: 2px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-link { background: none; border: none; color: var(--primary); font-weight: 600; padding: 8px; cursor: pointer; }
        .text-center { text-align: center; margin-top: 16px; }

        /* Onboarding */
        .onboarding-screen { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 24px; min-height: 100vh; display: flex; flex-direction: column; }
        .progress-bar { background: rgba(255,255,255,0.2); height: 6px; border-radius: 10px; margin-bottom: 32px; }
        .progress-fill { background: white; height: 100%; border-radius: 10px; transition: width 0.3s; }
        .progress-text { color: white; text-align: center; font-size: 14px; margin-bottom: 8px; font-weight: 600; }
        .onboarding-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .onboarding-question { color: white; font-size: 28px; font-weight: 700; margin-bottom: 32px; text-align: center; }
        .onboarding-options { display: flex; flex-direction: column; gap: 16px; margin-bottom: 32px; }
        .option-card { background: white; padding: 24px; border-radius: 16px; cursor: pointer; transition: all 0.3s; border: 3px solid transparent; display: flex; align-items: center; gap: 16px; }
        .option-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .option-card.selected { border-color: var(--primary); background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
        .option-icon { font-size: 32px; width: 50px; text-align: center; }
        .option-text h3 { font-size: 18px; margin-bottom: 4px; }
        .option-text p { font-size: 14px; color: var(--text-secondary); }
        .btn-back { background: rgba(255,255,255,0.2); color: white; padding: 12px; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border: none; margin-bottom: 24px; }

        /* Summary */
        .summary-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .summary-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { color: var(--text-secondary); font-size: 14px; }
        .summary-value { font-weight: 600; font-size: 16px; }
        .summary-highlight { background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px; margin-top: 16px; text-align: center; }
        .summary-highlight-value { font-size: 48px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .summary-highlight-label { color: var(--text-secondary); font-size: 14px; margin-top: 8px; }

        /* Main App */
        .main-app { display: flex; flex-direction: column; min-height: 100vh; }
        .header { padding: 20px; background: white; border-bottom: 1px solid var(--border); }
        .header h1 { font-size: 24px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .content { flex: 1; padding: 20px; padding-bottom: 90px; }
        .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }

        /* Camera */
        .camera-screen { background: #000; position: relative; min-height: 100vh; }
        #cameraVideo { width: 100%; height: 100vh; object-fit: cover; }
        #canvas { display: none; }
        .camera-close { position: absolute; top: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; font-size: 24px; cursor: pointer; z-index: 10; }
        .camera-controls { position: absolute; bottom: 40px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 10; }
        .camera-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.5); font-size: 32px; cursor: pointer; }
        .camera-fallback { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 40px; color: white; text-align: center; }
        .camera-fallback h2 { font-size: 24px; margin: 20px 0; }
        .camera-fallback p { margin-bottom: 24px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-btn { padding: 16px 32px; background: white; color: var(--primary); border-radius: 12px; font-weight: 600; cursor: pointer; }

        /* Camera FAB */
        .camera-fab { position: fixed; bottom: 90px; right: 24px; width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(16,185,129,0.4); z-index: 99; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 420px; margin: 0 auto; background: var(--surface); border-top: 1px solid var(--border); display: flex; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-secondary); padding: 8px; border-radius: 12px; }
        .nav-item.active { color: var(--primary); background: rgba(16,185,129,0.1); }
        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 11px; font-weight: 600; }

        /* Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--text); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 2000; display: none; max-width: 90%; }
        .toast.show { display: block; animation: slideDown 0.3s; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* Profile */
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-size: 48px; margin: 0 auto 16px; }
        .profile-info { text-align: center; margin-bottom: 24px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }

        /* Macro Grid */
        .macro-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
        .macro-item { text-align: center; padding: 16px; background: var(--background); border-radius: 12px; }
        .macro-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .macro-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="app">
        <div class="toast" id="toast"></div>

        <!-- LOGIN -->
        <div class="screen active" id="loginScreen">
            <div class="auth-screen">
                <div class="auth-logo">
                    <div class="icon">ü•ó</div>
                    <h1>NutriVision AI</h1>
                    <p>Nutri√ß√£o Inteligente</p>
                </div>
                <div class="auth-card">
                    <h2>Entrar</h2>
                    <form id="loginForm">
                        <div class="form-group" id="loginEmailGroup">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required>
                            <span class="form-error">Email inv√°lido</span>
                        </div>
                        <div class="form-group" id="loginPasswordGroup">
                            <label>Senha</label>
                            <input type="password" id="loginPassword" required>
                            <span class="form-error">Senha incorreta</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Entrar</button>
                        <div class="text-center">
                            <button type="button" class="btn-link" id="goToRegisterBtn">Criar conta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- REGISTER -->
        <div class="screen" id="registerScreen">
            <div class="auth-screen">
                <div class="auth-logo">
                    <div class="icon">üìù</div>
                    <h1>Criar Conta</h1>
                </div>
                <div class="auth-card">
                    <h2>Cadastro</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="registerName" required>
                        </div>
                        <div class="form-group" id="registerEmailGroup">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required>
                            <span class="form-error">Email inv√°lido</span>
                        </div>
                        <div class="form-group" id="registerPasswordGroup">
                            <label>Senha</label>
                            <input type="password" id="registerPassword" required>
                            <span class="form-error">M√≠nimo 6 caracteres</span>
                        </div>
                        <div class="form-group" id="registerPasswordConfirmGroup">
                            <label>Confirmar Senha</label>
                            <input type="password" id="registerPasswordConfirm" required>
                            <span class="form-error">Senhas n√£o coincidem</span>
                        </div>
                        <button type="submit" class="btn btn-primary">Criar Conta</button>
                        <div class="text-center">
                            <button type="button" class="btn-link" id="goToLoginBtn">J√° tenho conta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ONBOARDING 1: OBJETIVO -->
        <div class="screen" id="onboarding1Screen">
            <div class="onboarding-screen">
                <div>
                    <div class="progress-text">Passo 1 de 5</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 20%"></div></div>
                </div>
                <div class="onboarding-content">
                    <h2 class="onboarding-question">Qual √© o seu objetivo?</h2>
                    <div class="onboarding-options">
                        <div class="option-card" onclick="selectGoal('lose')">
                            <div class="option-icon">üî•</div>
                            <div class="option-text">
                                <h3>Perder Peso</h3>
                                <p>D√©ficit cal√≥rico</p>
                            </div>
                        </div>
                        <div class="option-card" onclick="selectGoal('maintain')">
                            <div class="option-icon">‚öñÔ∏è</div>
                            <div class="option-text">
                                <h3>Manter Peso</h3>
                                <p>Equil√≠brio</p>
                            </div>
                        </div>
                        <div class="option-card" onclick="selectGoal('gain')">
                            <div class="option-icon">üí™</div>
                            <div class="option-text">
                                <h3>Ganhar Massa</h3>
                                <p>Super√°vit cal√≥rico</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="goToOnboarding2()" id="onb1Btn" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- ONBOARDING 2: PESO ATUAL -->
        <div class="screen" id="onboarding2Screen">
            <div class="onboarding-screen">
                <div>
                    <button class="btn-back" onclick="navigateTo('onboarding1Screen')">‚Üê</button>
                    <div class="progress-text">Passo 2 de 5</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 40%"></div></div>
                </div>
                <div class="onboarding-content">
                    <h2 class="onboarding-question">Qual √© o seu peso atual?</h2>
                    <div class="auth-card">
                        <div class="form-group">
                            <label>Peso Atual (kg)</label>
                            <input type="number" id="currentWeight" placeholder="Ex: 70" min="30" max="300" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Altura (cm)</label>
                            <input type="number" id="height" placeholder="Ex: 170" min="100" max="250">
                        </div>
                        <div class="form-group">
                            <label>Idade</label>
                            <input type="number" id="age" placeholder="Ex: 25" min="13" max="100">
                        </div>
                        <div class="form-group">
                            <label>Sexo</label>
                            <select id="gender">
                                <option value="male">Masculino</option>
                                <option value="female">Feminino</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="goToOnboarding3()">Continuar</button>
                </div>
            </div>
        </div>

        <!-- ONBOARDING 3: META DE PESO -->
        <div class="screen" id="onboarding3Screen">
            <div class="onboarding-screen">
                <div>
                    <button class="btn-back" onclick="navigateTo('onboarding2Screen')">‚Üê</button>
                    <div class="progress-text">Passo 3 de 5</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 60%"></div></div>
                </div>
                <div class="onboarding-content">
                    <h2 class="onboarding-question" id="weightGoalQuestion">Qual √© sua meta?</h2>
                    <div class="auth-card">
                        <div class="form-group">
                            <label id="targetWeightLabel">Peso Meta (kg)</label>
                            <input type="number" id="targetWeight" placeholder="Ex: 65" min="30" max="300" step="0.1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="goToOnboarding4()">Continuar</button>
                </div>
            </div>
        </div>

        <!-- ONBOARDING 4: ATIVIDADE -->
        <div class="screen" id="onboarding4Screen">
            <div class="onboarding-screen">
                <div>
                    <button class="btn-back" onclick="navigateTo('onboarding3Screen')">‚Üê</button>
                    <div class="progress-text">Passo 4 de 5</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 80%"></div></div>
                </div>
                <div class="onboarding-content">
                    <h2 class="onboarding-question">N√≠vel de atividade?</h2>
                    <div class="onboarding-options">
                        <div class="option-card" onclick="selectActivity('sedentary')">
                            <div class="option-icon">üõãÔ∏è</div>
                            <div class="option-text"><h3>Sedent√°rio</h3></div>
                        </div>
                        <div class="option-card" onclick="selectActivity('light')">
                            <div class="option-icon">üö∂</div>
                            <div class="option-text"><h3>Levemente Ativo</h3></div>
                        </div>
                        <div class="option-card" onclick="selectActivity('moderate')">
                            <div class="option-icon">üèÉ</div>
                            <div class="option-text"><h3>Moderadamente Ativo</h3></div>
                        </div>
                        <div class="option-card" onclick="selectActivity('very')">
                            <div class="option-icon">üí™</div>
                            <div class="option-text"><h3>Muito Ativo</h3></div>
                        </div>
                        <div class="option-card" onclick="selectActivity('extra')">
                            <div class="option-icon">üèãÔ∏è</div>
                            <div class="option-text"><h3>Atleta</h3></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="goToOnboarding5()" id="onb4Btn" disabled>Continuar</button>
                </div>
            </div>
        </div>

        <!-- ONBOARDING 5: RESUMO -->
        <div class="screen" id="onboarding5Screen">
            <div class="onboarding-screen">
                <div>
                    <button class="btn-back" onclick="navigateTo('onboarding4Screen')">‚Üê</button>
                    <div class="progress-text">Passo 5 de 5</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 100%"></div></div>
                </div>
                <div class="onboarding-content">
                    <h2 class="onboarding-question">Suas Metas</h2>
                    <div class="summary-card">
                        <div class="summary-item">
                            <span class="summary-label">Objetivo</span>
                            <span class="summary-value" id="sumGoal">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Peso Atual</span>
                            <span class="summary-value" id="sumCurrent">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Peso Meta</span>
                            <span class="summary-value" id="sumTarget">-</span>
                        </div>
                        <div class="summary-highlight">
                            <div class="summary-highlight-value" id="sumCalories">2000</div>
                            <div class="summary-highlight-label">Calorias Di√°rias</div>
                        </div>
                        <div class="macro-grid">
                            <div class="macro-item">
                                <div class="macro-value" id="sumProtein">150g</div>
                                <div class="macro-label">Prote√≠na</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="sumCarbs">250g</div>
                                <div class="macro-label">Carbos</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-value" id="sumFat">60g</div>
                                <div class="macro-label">Gorduras</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="completeOnboarding()">Confirmar e Entrar</button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div class="screen" id="dashboardScreen">
            <div class="main-app">
                <div class="header">
                    <h1>Dashboard</h1>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="card-title">üî• Calorias Di√°rias</div>
                        <div class="empty-state">
                            <div class="empty-state-icon">üì∑</div>
                            <p>Tire uma foto da sua refei√ß√£o<br>para come√ßar!</p>
                        </div>
                    </div>
                </div>
                <button class="camera-fab" onclick="openCamera()">üì∑</button>
                <div class="bottom-nav">
                    <div class="nav-item active" onclick="navigateToTab('dashboardScreen')">
                        <span class="nav-icon">üè†</span>
                        <span class="nav-label">In√≠cio</span>
                    </div>
                    <div class="nav-item" onclick="navigateToTab('historyScreen')">
                        <span class="nav-icon">üìñ</span>
                        <span class="nav-label">Hist√≥rico</span>
                    </div>
                    <div class="nav-item" onclick="openCamera()">
                        <span class="nav-icon">üì∑</span>
                        <span class="nav-label">Scan</span>
                    </div>
                    <div class="nav-item" onclick="navigateToTab('profileScreen')">
                        <span class="nav-icon">üë§</span>
                        <span class="nav-label">Perfil</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CAMERA -->
        <div class="screen" id="cameraScreen">
            <div class="camera-screen">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div id="cameraFallback" class="camera-fallback" style="display:none;">
                    <div class="icon" style="font-size: 80px;">üì∑</div>
                    <h2>C√¢mera n√£o dispon√≠vel</h2>
                    <p>Use o upload de imagem para continuar</p>
                    <div class="file-input-wrapper">
                        <label class="file-input-btn">
                            Escolher Foto
                            <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                        </label>
                    </div>
                </div>
                <button class="camera-close" onclick="closeCamera()">‚úï</button>
                <div class="camera-controls">
                    <button class="camera-btn" onclick="capturePhoto()">üì∑</button>
                </div>
            </div>
        </div>

        <!-- HISTORY -->
        <div class="screen" id="historyScreen">
            <div class="main-app">
                <div class="header"><h1>Hist√≥rico</h1></div>
                <div class="content">
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Nenhuma refei√ß√£o registrada</p>
                        </div>
                    </div>
                </div>
                <div class="bottom-nav">
                    <div class="nav-item" onclick="navigateToTab('dashboardScreen')"><span class="nav-icon">üè†</span><span class="nav-label">In√≠cio</span></div>
                    <div class="nav-item active" onclick="navigateToTab('historyScreen')"><span class="nav-icon">üìñ</span><span class="nav-label">Hist√≥rico</span></div>
                    <div class="nav-item" onclick="openCamera()"><span class="nav-icon">üì∑</span><span class="nav-label">Scan</span></div>
                    <div class="nav-item" onclick="navigateToTab('profileScreen')"><span class="nav-icon">üë§</span><span class="nav-label">Perfil</span></div>
                </div>
            </div>
        </div>

        <!-- PROFILE -->
        <div class="screen" id="profileScreen">
            <div class="main-app">
                <div class="header"><h1>Perfil</h1></div>
                <div class="content">
                    <div class="card" style="text-align: center;">
                        <div class="profile-avatar">üë§</div>
                        <div class="profile-info">
                            <h2 id="profileName">Usu√°rio</h2>
                            <p id="profileEmail">email@exemplo.com</p>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="handleLogout()">Sair da Conta</button>
                </div>
                <div class="bottom-nav">
                    <div class="nav-item" onclick="navigateToTab('dashboardScreen')"><span class="nav-icon">üè†</span><span class="nav-label">In√≠cio</span></div>
                    <div class="nav-item" onclick="navigateToTab('historyScreen')"><span class="nav-icon">üìñ</span><span class="nav-label">Hist√≥rico</span></div>
                    <div class="nav-item" onclick="openCamera()"><span class="nav-icon">üì∑</span><span class="nav-label">Scan</span></div>
                    <div class="nav-item active" onclick="navigateToTab('profileScreen')"><span class="nav-icon">üë§</span><span class="nav-label">Perfil</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let onboardingData = {};
        let cameraStream = null;

        function init() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
                const userData = JSON.parse(localStorage.getItem(`userData_${currentUser.email}`) || 'null');
                if (!userData || !userData.goals) {
                    navigateTo('onboarding1Screen');
                } else {
                    navigateTo('dashboardScreen');
                    updateProfile();
                }
            } else {
                navigateTo('loginScreen');
            }
            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('goToRegisterBtn').addEventListener('click', () => navigateTo('registerScreen'));
            document.getElementById('goToLoginBtn').addEventListener('click', () => navigateTo('loginScreen'));
        }

        function navigateTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function navigateToTab(screenId) {
            if (!currentUser) {
                showToast('Fa√ßa login', 'error');
                navigateTo('loginScreen');
                return;
            }
            navigateTo(screenId);
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[email];
            if (!user || user.password !== password) {
                showToast('Credenciais incorretas', 'error');
                return;
            }
            currentUser = { name: user.name, email: user.email };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            const userData = JSON.parse(localStorage.getItem(`userData_${email}`) || 'null');
            if (!userData || !userData.goals) {
                navigateTo('onboarding1Screen');
            } else {
                showToast(`Bem-vindo, ${user.name}!`, 'success');
                navigateTo('dashboardScreen');
                updateProfile();
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerPasswordConfirm').value;
            if (password.length < 6) {
                showToast('Senha muito curta', 'error');
                return;
            }
            if (password !== confirm) {
                showToast('Senhas n√£o coincidem', 'error');
                return;
            }
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[email]) {
                showToast('Email j√° cadastrado', 'error');
                return;
            }
            users[email] = { name, email, password };
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = { name, email };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showToast('Conta criada!', 'success');
            navigateTo('onboarding1Screen');
        }

        function selectGoal(goal) {
            onboardingData.goal = goal;
            document.querySelectorAll('#onboarding1Screen .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('onb1Btn').disabled = false;
        }

        function goToOnboarding2() {
            if (!onboardingData.goal) return;
            navigateTo('onboarding2Screen');
        }

        function goToOnboarding3() {
            onboardingData.currentWeight = parseFloat(document.getElementById('currentWeight').value);
            onboardingData.height = parseInt(document.getElementById('height').value);
            onboardingData.age = parseInt(document.getElementById('age').value);
            onboardingData.gender = document.getElementById('gender').value;
            if (!onboardingData.currentWeight || !onboardingData.height || !onboardingData.age) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            navigateTo('onboarding3Screen');
        }

        function goToOnboarding4() {
            onboardingData.targetWeight = parseFloat(document.getElementById('targetWeight').value);
            if (!onboardingData.targetWeight) {
                showToast('Insira o peso meta', 'error');
                return;
            }
            navigateTo('onboarding4Screen');
        }

        function selectActivity(activity) {
            onboardingData.activity = activity;
            document.querySelectorAll('#onboarding4Screen .option-card').forEach(c => c.classList.remove('selected'));
            event.target.closest('.option-card').classList.add('selected');
            document.getElementById('onb4Btn').disabled = false;
        }

        function goToOnboarding5() {
            if (!onboardingData.activity) return;
            const goals = calculateTDEE(onboardingData);
            onboardingData.goals = goals;
            document.getElementById('sumGoal').textContent = onboardingData.goal === 'lose' ? 'Perder Peso' : onboardingData.goal === 'gain' ? 'Ganhar Massa' : 'Manter Peso';
            document.getElementById('sumCurrent').textContent = onboardingData.currentWeight + ' kg';
            document.getElementById('sumTarget').textContent = onboardingData.targetWeight + ' kg';
            document.getElementById('sumCalories').textContent = goals.calories;
            document.getElementById('sumProtein').textContent = goals.protein + 'g';
            document.getElementById('sumCarbs').textContent = goals.carbs + 'g';
            document.getElementById('sumFat').textContent = goals.fat + 'g';
            navigateTo('onboarding5Screen');
        }

        function calculateTDEE(data) {
            let bmr = data.gender === 'male' 
                ? (10 * data.currentWeight) + (6.25 * data.height) - (5 * data.age) + 5
                : (10 * data.currentWeight) + (6.25 * data.height) - (5 * data.age) - 161;
            const multipliers = { sedentary: 1.2, light: 1.375, moderate: 1.55, very: 1.725, extra: 1.9 };
            let tdee = bmr * multipliers[data.activity];
            if (data.goal === 'lose') tdee *= 0.80;
            else if (data.goal === 'gain') tdee *= 1.10;
            return {
                calories: Math.round(tdee),
                protein: Math.round(data.currentWeight * 2),
                carbs: Math.round((tdee * 0.45) / 4),
                fat: Math.round((tdee * 0.30) / 9)
            };
        }

        function completeOnboarding() {
            localStorage.setItem(`userData_${currentUser.email}`, JSON.stringify(onboardingData));
            showToast('Metas configuradas!', 'success');
            navigateTo('dashboardScreen');
            updateProfile();
        }

        async function openCamera() {
            navigateTo('cameraScreen');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraVideo').style.display = 'block';
                document.getElementById('cameraFallback').style.display = 'none';
                document.querySelector('.camera-controls').style.display = 'flex';
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                document.getElementById('cameraVideo').style.display = 'none';
                document.getElementById('cameraFallback').style.display = 'flex';
                document.querySelector('.camera-controls').style.display = 'none';
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            navigateTo('dashboardScreen');
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg');
            showToast('Foto capturada! (An√°lise em breve)', 'success');
            setTimeout(() => closeCamera(), 1000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                showToast('Foto enviada! (An√°lise em breve)', 'success');
                setTimeout(() => closeCamera(), 1000);
            }
        }

        function updateProfile() {
            if (!currentUser) return;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
        }

        function handleLogout() {
            if (confirm('Deseja sair?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showToast('At√© logo!', 'success');
                setTimeout(() => navigateTo('loginScreen'), 500);
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
