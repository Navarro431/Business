import { useState, useEffect, useCallback, useMemo, memo, useRef } from "react";

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß1  DESIGN TOKENS  (shared across ALL screens)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const DARK = {
  bg:'#07070c', bgAlt:'#0d0d16', surf:'#111120', surf2:'#181828',
  surf3:'#1f1f33', surf4:'#262640', bdr:'rgba(255,255,255,0.07)',
  bdr2:'rgba(255,255,255,0.13)', text:'#f0f0fc', sec:'#6868a0',
  muted:'#3a3a5c', lime:'#aaee22', limeG:'rgba(170,238,34,0.18)',
  limeDim:'rgba(170,238,34,0.08)', teal:'#22eebb', tealDim:'rgba(34,238,187,0.08)',
  violet:'#9977ff', violetDim:'rgba(153,119,255,0.1)', orange:'#ee9922',
  orangeDim:'rgba(238,153,34,0.08)', pink:'#ee22aa', pinkDim:'rgba(238,34,170,0.08)',
  red:'#ee3333', redDim:'rgba(238,51,51,0.08)', green:'#33ee88',
  greenDim:'rgba(51,238,136,0.08)', cyan:'#22ccee', cyanDim:'rgba(34,204,238,0.08)',
  shadow:'0 2px 20px rgba(0,0,0,0.5)', shadowMd:'0 4px 32px rgba(0,0,0,0.6)',
};
const LIGHT = {
  bg:'#f5f4f0', bgAlt:'#eeede8', surf:'#ffffff', surf2:'#f8f7f3',
  surf3:'#f0efe9', surf4:'#e8e7e0', bdr:'rgba(0,0,0,0.08)',
  bdr2:'rgba(0,0,0,0.14)', text:'#1a1a2a', sec:'#6060a0',
  muted:'#a0a0c0', lime:'#4a8800', limeG:'rgba(74,136,0,0.15)',
  limeDim:'rgba(74,136,0,0.08)', teal:'#007755', tealDim:'rgba(0,119,85,0.08)',
  violet:'#5533cc', violetDim:'rgba(85,51,204,0.08)', orange:'#bb6600',
  orangeDim:'rgba(187,102,0,0.08)', pink:'#cc0077', pinkDim:'rgba(204,0,119,0.08)',
  red:'#cc2200', redDim:'rgba(204,34,0,0.08)', green:'#007733',
  greenDim:'rgba(0,119,51,0.08)', cyan:'#006688', cyanDim:'rgba(0,102,136,0.08)',
  shadow:'0 2px 12px rgba(0,0,0,0.08)', shadowMd:'0 4px 24px rgba(0,0,0,0.12)',
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß2  PURE UTILITY FUNCTIONS  (shared, no duplication)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const clamp    = (v, lo, hi) => Math.min(Math.max(v, lo), hi);
const calcBMR  = (age, gender, kg, cm) =>
  gender === 'female'
    ? Math.round(10*kg + 6.25*cm - 5*age - 161)
    : Math.round(10*kg + 6.25*cm - 5*age + 5);
const TDEE_M   = { sedentary:1.2, light:1.375, moderate:1.55, active:1.725 };
const calcTDEE = (bmr, act) => Math.round(bmr * (TDEE_M[act] || 1.375));
const calcTarget  = (tdee, goal) => goal==='lose'?tdee-500:goal==='gain'?tdee+300:tdee;
const calcMacros  = (cal, diet) => {
  const s = {
    highprotein:{p:.40,c:.35,f:.25}, balanced:{p:.30,c:.40,f:.30},
    lowcarb:{p:.40,c:.20,f:.40}, vegetarian:{p:.25,c:.50,f:.25},
  }[diet] || {p:.30,c:.40,f:.30};
  return { protein:Math.round(cal*s.p/4), carbs:Math.round(cal*s.c/4), fat:Math.round(cal*s.f/9) };
};

function getGreeting() {
  const h = new Date().getHours();
  return h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß3  INITIAL DATA / MOCKS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const INIT_USER = {
  name:'Felipe Gomes', age:28, gender:'male', heightCm:180, weightKg:84.1,
  targetWeightKg:77, goal_type:'lose', activity:'moderate', diet:'highprotein',
  plan:'pro', calorie_target:2100, protein_target:168, carb_target:184, fat_target:58,
  streak:11, longestStreak:18,
};

// Zero state for a brand-new day / first-time user
const ZERO_DAILY = {
  consumed:0, protein:0, carbs:0, fat:0, burned:0,
  meals:[
    { id:1, type:'breakfast', emoji:'üåÖ', name:null, calories:0, protein:0, carbs:0, fat:0, time:null, logged:false },
    { id:2, type:'lunch',     emoji:'‚òÄÔ∏è', name:null, calories:0, protein:0, carbs:0, fat:0, time:null, logged:false },
    { id:3, type:'dinner',    emoji:'üåô', name:null, calories:0, protein:0, carbs:0, fat:0, time:null, logged:false },
    { id:4, type:'snacks',    emoji:'‚ö°', name:null, calories:0, protein:0, carbs:0, fat:0, time:null, logged:false },
  ],
};

const MEAL_LABELS = { breakfast:'Breakfast', lunch:'Lunch', dinner:'Dinner', snacks:'Snacks' };

const genWeightLogs = (startKg = 87.4, days = 42) => {
  const logs = []; let w = startKg;
  for (let i = days; i >= 0; i--) {
    w += (Math.random() - .62) * .35;
    const d = new Date(); d.setDate(d.getDate() - i);
    logs.push({ date: d.toISOString().split('T')[0], weight: +w.toFixed(1) });
  }
  return logs;
};
const genDailyLogs = (target = 2100, days = 42) => {
  const logs = [];
  for (let i = days; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const hit = Math.random() > .28;
    const cal = hit ? target + Math.round((Math.random() - .5) * 280) : target * (.6 + Math.random() * .25);
    logs.push({
      date: d.toISOString().split('T')[0], calories: Math.round(cal),
      protein: Math.round(cal*.37/4), carbs: Math.round(cal*.36/4), fat: Math.round(cal*.27/9),
    });
  }
  return logs;
};

// Fake scan meals pool
const SCAN_POOL = [
  { name:'Grilled Chicken & Quinoa', emoji:'üçó', calories:488, protein:44, carbs:38, fat:12 },
  { name:'Greek Yogurt Bowl',        emoji:'ü•£', calories:310, protein:22, carbs:36, fat:8  },
  { name:'Tuna Avocado Wrap',        emoji:'üåØ', calories:420, protein:34, carbs:30, fat:14 },
  { name:'Salmon & Sweet Potato',    emoji:'üêü', calories:540, protein:42, carbs:44, fat:16 },
  { name:'Protein Smoothie',         emoji:'ü´ê', calories:320, protein:28, carbs:32, fat:7  },
  { name:'Egg White Omelette',       emoji:'üç≥', calories:260, protein:24, carbs:8,  fat:10 },
];

const AI_INSIGHTS_POOL = [
  { type:'success', icon:'‚ú¶', msg:'You\'re <strong>ahead on protein</strong> today ‚Äî great muscle support!' },
  { type:'info',    icon:'‚Ñπ', msg:'Only <strong>420 kcal remaining</strong>. A light dinner will keep you on track.' },
  { type:'warning', icon:'‚ö†', msg:'Carbs are <strong>18% below target</strong>. Consider adding a whole-grain side.' },
  { type:'success', icon:'‚ú¶', msg:'<strong>11-day streak</strong> ‚Äî you\'re in the top 12% of all users!' },
  { type:'info',    icon:'‚Ñπ', msg:'Fat intake is balanced. Your macro split is <strong>near optimal</strong> for cutting.' },
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß4  i18n
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const I18N = {
  en:{
    home:'Home', ideas:'Ideas', profile:'Profile', stats:'Stats',
    weight:'Weight', macros:'Macros', streak:'Streak', ai:'AI Report',
    editProfile:'Edit Profile', saveChanges:'Save Changes', cancel:'Cancel',
    currentWeight:'Current Weight', targetWeight:'Target Weight',
    activity:'Activity Level', goal:'Goal', diet:'Diet',
    calories:'Calories', protein:'Protein', carbs:'Carbs', fat:'Fat',
    weeklyAvg:'Weekly Avg', daysOnTarget:'Days On Target', adherenceScore:'Adherence Score',
    currentStreak:'Current Streak', longestStreak:'Longest Streak', weekCompletion:'This Week',
    startLogging:'Start logging to unlock your progress insights.',
    noData:'No data yet', scan:'Scan Meal',
    journeyStart:'Your journey starts today.',
    scanFirst:'Scan your first meal to begin.',
    mealIdeas:'AI Meal Ideas', generateIdeas:'Generate 3 Meal Ideas',
    remaining:'Remaining', generating:'Generating‚Ä¶',
  },
  es:{
    home:'Inicio', ideas:'Ideas', profile:'Perfil', stats:'Estad√≠sticas',
    weight:'Peso', macros:'Macros', streak:'Racha', ai:'IA Reporte',
    editProfile:'Editar Perfil', saveChanges:'Guardar', cancel:'Cancelar',
    currentWeight:'Peso Actual', targetWeight:'Peso Objetivo',
    activity:'Nivel de Actividad', goal:'Objetivo', diet:'Dieta',
    calories:'Calor√≠as', protein:'Prote√≠na', carbs:'Carbos', fat:'Grasa',
    weeklyAvg:'Prom. Semanal', daysOnTarget:'D√≠as en Meta', adherenceScore:'Puntuaci√≥n',
    currentStreak:'Racha Actual', longestStreak:'Racha M√°xima', weekCompletion:'Esta Semana',
    startLogging:'Empieza a registrar para ver tus estad√≠sticas.',
    noData:'Sin datos', scan:'Escanear',
    journeyStart:'Tu viaje comienza hoy.',
    scanFirst:'Escanea tu primera comida.',
    mealIdeas:'Ideas con IA', generateIdeas:'Generar 3 Ideas',
    remaining:'Restante', generating:'Generando‚Ä¶',
  },
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß5  GLOBAL CSS FACTORY  (all screens, one injection)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const makeCSS = (T) => `
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800;900&family=Nunito:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap');
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:${T.bg};--bgAlt:${T.bgAlt};--s:${T.surf};--s2:${T.surf2};--s3:${T.surf3};--s4:${T.surf4};
    --b:${T.bdr};--b2:${T.bdr2};--t:${T.text};--ts:${T.sec};--tm:${T.muted};
    --lime:${T.lime};--teal:${T.teal};--violet:${T.violet};--orange:${T.orange};
    --pink:${T.pink};--red:${T.red};--green:${T.green};--cyan:${T.cyan};
    --fh:'Syne',sans-serif;--fb:'Nunito',sans-serif;
    --ease:cubic-bezier(.4,0,.2,1);--spring:cubic-bezier(.34,1.56,.64,1);
    --r1:12px;--r2:18px;--r3:24px;--r4:30px;
  }
  html,body,#root{height:100%;background:var(--bg);color:var(--t);font-family:var(--fb);-webkit-font-smoothing:antialiased}
  .shell{max-width:430px;min-height:100vh;margin:0 auto;background:var(--bg);position:relative;overflow:hidden;display:flex;flex-direction:column}
  .shell::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9000;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.022'/%3E%3C/svg%3E")}
  .scroll{flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;padding-bottom:110px}
  .scroll::-webkit-scrollbar{display:none}

  /* ‚îÄ‚îÄ Keyframes ‚îÄ‚îÄ */
  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes spinR{from{transform:rotate(0deg)}to{transform:rotate(-360deg)}}
  @keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
  @keyframes drawLine{from{stroke-dashoffset:3000}to{stroke-dashoffset:0}}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.45;transform:scale(.9)}}
  @keyframes breathe{0%,100%{box-shadow:0 0 0 0 ${T.limeG}}50%{box-shadow:0 0 0 14px rgba(0,0,0,0)}}
  @keyframes orbSpin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @keyframes orbPulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 ${T.limeG}}50%{transform:scale(1.06);box-shadow:0 0 0 14px rgba(0,0,0,0)}}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  @keyframes ideaIn{from{opacity:0;transform:translateY(18px) scale(.97)}to{opacity:1;transform:none}}
  @keyframes fabPulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.08)}}
  @keyframes scanLine{0%{top:12%}100%{top:85%}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

  .a1{animation:fadeUp .44s var(--ease) .04s both}
  .a2{animation:fadeUp .44s var(--ease) .10s both}
  .a3{animation:fadeUp .44s var(--ease) .16s both}
  .a4{animation:fadeUp .44s var(--ease) .22s both}
  .a5{animation:fadeUp .44s var(--ease) .28s both}
  .a6{animation:fadeUp .44s var(--ease) .34s both}
  .a7{animation:fadeUp .44s var(--ease) .40s both}

  /* ‚îÄ‚îÄ Base card ‚îÄ‚îÄ */
  .card{background:var(--s);border:1px solid var(--b);border-radius:var(--r3);box-shadow:${T.shadow};overflow:hidden;transition:box-shadow .2s var(--ease)}
  .card:hover{box-shadow:${T.shadowMd}}
  .cp{padding:20px}

  /* ‚îÄ‚îÄ Skeleton ‚îÄ‚îÄ */
  .skel{background:linear-gradient(90deg,var(--s2) 0%,var(--s3) 50%,var(--s2) 100%);background-size:400px 100%;animation:shimmer 1.5s ease-in-out infinite;border-radius:8px}

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn-pri{background:var(--lime);color:#07070c;border:none;border-radius:var(--r2);padding:15px 22px;font-family:var(--fh);font-weight:800;font-size:14px;cursor:pointer;width:100%;transition:all .2s var(--spring);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 20px ${T.limeG}}
  .btn-pri::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.15),transparent 60%)}
  .btn-pri:hover{transform:translateY(-2px);box-shadow:0 8px 28px ${T.limeG}}
  .btn-pri:active{transform:scale(.97)}
  .btn-pri:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
  .btn-ghost{background:var(--s2);color:var(--ts);border:1px solid var(--b2);border-radius:var(--r2);padding:13px 22px;font-family:var(--fb);font-weight:600;font-size:14px;cursor:pointer;width:100%;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
  .btn-ghost:hover{background:var(--s3);color:var(--t)}
  .ib{width:36px;height:36px;border-radius:50%;background:var(--s);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;transition:all .2s var(--ease);flex-shrink:0}
  .ib:hover{background:var(--s2);transform:scale(1.06)}

  /* ‚îÄ‚îÄ Pill ‚îÄ‚îÄ */
  .pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:18px;font-size:10px;font-weight:800;letter-spacing:.4px;text-transform:uppercase}

  /* ‚îÄ‚îÄ Section ‚îÄ‚îÄ */
  .sec{padding:18px 20px 0}
  .sechd{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px}
  .sectitle{font-family:var(--fh);font-weight:800;font-size:17px;letter-spacing:-.4px}
  .secact{font-size:12px;font-weight:700;color:var(--lime);cursor:pointer}

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  .toast{position:fixed;top:52px;left:50%;transform:translateX(-50%);background:var(--t);color:var(--bg);padding:10px 20px;border-radius:20px;font-size:13px;font-weight:700;z-index:9999;white-space:nowrap;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:toastIn .3s var(--spring)}

  /* ‚îÄ‚îÄ Bottom nav ‚îÄ‚îÄ */
  .fabwrap{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:430px;z-index:200;pointer-events:none}
  .bnav{position:absolute;bottom:0;left:0;right:0;height:76px;background:${T.surf}f0;border-top:1px solid var(--b);backdrop-filter:blur(24px);display:flex;align-items:center;justify-content:space-around;padding:0 8px 12px;pointer-events:all}
  .nit{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:8px 4px;border-radius:11px;transition:all .2s}
  .nit:hover{background:var(--s2)}
  .nit.active{background:var(--s2)}
  .ni{font-size:18px}
  .nl{font-size:9px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--tm)}
  .nit.active .nl{color:var(--lime)}
  .fab{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);width:58px;height:58px;background:var(--lime);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;pointer-events:all;box-shadow:0 4px 24px ${T.limeG},0 8px 40px rgba(0,0,0,.4);transition:all .25s var(--spring);z-index:10;animation:breathe 2.8s ease-in-out infinite}
  .fab:hover{transform:translateX(-50%) scale(1.1)!important}
  .fab:active{transform:translateX(-50%) scale(.94)!important}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DASHBOARD-SPECIFIC
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  /* Date strip */
  .date-strip{display:flex;gap:6px;padding:14px 20px 0;overflow-x:auto;scrollbar-width:none}
  .date-strip::-webkit-scrollbar{display:none}
  .date-chip{flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding:9px 11px;border-radius:12px;cursor:pointer;min-width:44px;transition:all .2s var(--ease)}

  /* Calorie ring card */
  .ring-card{background:var(--s);border:1px solid var(--b);border-radius:var(--r4);padding:22px 20px;position:relative;overflow:hidden;box-shadow:${T.shadowMd}}
  .ring-orb{position:absolute;top:-70px;right:-70px;width:240px;height:240px;background:radial-gradient(circle,${T.limeG},transparent 70%);pointer-events:none}
  .ring-orb2{position:absolute;bottom:-50px;left:-50px;width:180px;height:180px;background:radial-gradient(circle,${T.tealDim},transparent 70%);pointer-events:none}
  .ring-layout{display:flex;align-items:center;gap:20px}
  .ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .ring-num{font-family:var(--fh);font-weight:900;font-size:26px;letter-spacing:-1.5px;line-height:1}
  .ring-unit{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ts);margin-top:2px}
  .ring-pct{font-family:var(--fh);font-weight:700;font-size:11px;color:var(--lime);margin-top:4px}
  .ring-stats{flex:1;display:flex;flex-direction:column;gap:12px}
  .rs-row{}
  .rs-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
  .rs-lbl{font-size:11px;font-weight:600;color:var(--ts);display:flex;align-items:center;gap:5px}
  .rs-dot{width:6px;height:6px;border-radius:50%}
  .rs-val{font-family:var(--fh);font-weight:700;font-size:11px}
  .bar-track{width:100%;height:4px;background:var(--s3);border-radius:2px;overflow:hidden}
  .bar-fill{height:100%;border-radius:2px;transition:width 1.4s cubic-bezier(.4,0,.2,1)}
  .ring-footer{display:flex;gap:8px;margin-top:18px}
  .rfc{flex:1;background:var(--s2);border-radius:12px;padding:10px 8px;text-align:center;border:1px solid var(--b)}
  .rfc-val{font-family:var(--fh);font-weight:800;font-size:14px;letter-spacing:-.5px;line-height:1}
  .rfc-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tm);margin-top:3px}

  /* Empty state hero */
  .empty-hero{background:var(--s);border:1px solid var(--b);border-radius:var(--r4);padding:34px 24px;text-align:center;position:relative;overflow:hidden;box-shadow:${T.shadowMd}}
  .eh-bg1{position:absolute;top:-80px;right:-80px;width:260px;height:260px;background:radial-gradient(circle,${T.limeG},transparent 70%);pointer-events:none}
  .eh-bg2{position:absolute;bottom:-60px;left:-60px;width:200px;height:200px;background:radial-gradient(circle,${T.tealDim},transparent 70%);pointer-events:none}
  .eh-orb{width:96px;height:96px;margin:0 auto 22px;position:relative}
  .eh-ring{width:96px;height:96px;border-radius:50%;border:2px solid ${T.limeDim};display:flex;align-items:center;justify-content:center;animation:orbSpin 8s linear infinite;position:relative}
  .eh-ring::before{content:'';position:absolute;top:-2px;left:50%;width:8px;height:8px;border-radius:50%;background:var(--lime);transform:translateX(-50%);box-shadow:0 0 10px var(--lime),0 0 20px ${T.limeG}}
  .eh-inner{width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,${T.limeDim},${T.tealDim});border:1px solid var(--b2);display:flex;align-items:center;justify-content:center;font-size:28px;animation:orbPulse 3s ease-in-out infinite}
  .eh-title{font-family:var(--fh);font-weight:900;font-size:22px;letter-spacing:-.6px;line-height:1.2;margin-bottom:10px}
  .eh-title em{color:var(--lime);font-style:normal}
  .eh-sub{font-size:13px;color:var(--ts);line-height:1.65;max-width:280px;margin:0 auto 26px}
  .eh-cta{display:inline-flex;align-items:center;gap:9px;background:var(--lime);color:#07070c;border:none;border-radius:var(--r2);padding:14px 26px;font-family:var(--fh);font-weight:800;font-size:14px;cursor:pointer;transition:all .25s var(--spring);position:relative;overflow:hidden;box-shadow:0 6px 24px ${T.limeG}}
  .eh-cta::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.18),transparent 60%)}
  .eh-cta:hover{transform:translateY(-2px);box-shadow:0 10px 32px ${T.limeG}}
  .eh-zero-row{display:flex;gap:0;margin-top:22px;padding-top:22px;border-top:1px solid var(--b)}
  .eh-zc{flex:1;text-align:center}
  .eh-zring{width:40px;height:40px;border-radius:50%;border:2px dashed var(--b2);display:flex;align-items:center;justify-content:center;margin:0 auto 7px;font-family:var(--fh);font-weight:800;font-size:13px;color:var(--tm)}
  .eh-zlbl{font-size:9px;color:var(--tm);text-transform:uppercase;letter-spacing:.5px;font-weight:700}

  /* Empty meal slots */
  .empty-slot{background:var(--s);border:1px dashed var(--b2);border-radius:var(--r2);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;cursor:pointer;transition:all .2s var(--ease);animation:fadeUp .4s var(--ease) both}
  .empty-slot:hover{border-color:var(--lime);background:${T.limeDim}}
  .es-icon{width:38px;height:38px;border-radius:10px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:18px;opacity:.5;flex-shrink:0}
  .es-info{flex:1}
  .es-name{font-size:13px;font-weight:700;color:var(--ts)}
  .es-sub{font-size:11px;color:var(--tm);margin-top:2px}
  .es-add{font-size:20px;color:var(--tm);transition:all .2s var(--spring)}
  .empty-slot:hover .es-add{color:var(--lime);transform:rotate(90deg) scale(1.2)}

  /* Meal card (logged) */
  .meal-card{background:var(--s);border:1px solid var(--b);border-radius:var(--r2);margin-bottom:8px;overflow:hidden;animation:fadeUp .4s var(--ease) both;transition:all .2s}
  .meal-card:hover{border-color:var(--b2);transform:translateY(-1px)}
  .mc-top{padding:13px 16px;display:flex;align-items:center;gap:12px}
  .mc-icon{width:40px;height:40px;border-radius:11px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:20px;border:1px solid var(--b);flex-shrink:0}
  .mc-info{flex:1}
  .mc-name{font-family:var(--fh);font-weight:700;font-size:13px;margin-bottom:2px}
  .mc-time{font-size:11px;color:var(--ts)}
  .mc-right{text-align:right}
  .mc-cal{font-family:var(--fh);font-weight:800;font-size:16px;letter-spacing:-.5px;color:var(--lime)}
  .mc-unit{font-size:9px;color:var(--tm);text-transform:uppercase;letter-spacing:.5px}
  .mc-macros{display:flex;border-top:1px solid var(--b)}
  .mc-macro{flex:1;padding:8px 6px;text-align:center;border-right:1px solid var(--b)}
  .mc-macro:last-child{border-right:none}
  .mc-mv{font-family:var(--fh);font-weight:700;font-size:13px}
  .mc-ml{font-size:8px;color:var(--tm);text-transform:uppercase;letter-spacing:.5px;margin-top:1px}

  /* Nudge banner */
  .nudge{background:linear-gradient(135deg,${T.orangeDim},${T.limeDim});border:1px solid ${T.orange}28;border-radius:var(--r2);padding:13px 15px;display:flex;align-items:center;gap:11px;cursor:pointer;transition:all .2s var(--ease);animation:fadeUp .5s var(--spring) .3s both}
  .nudge:hover{border-color:${T.orange}50}
  .nudge-ico{font-size:22px;flex-shrink:0}
  .nudge-txt{flex:1}
  .nudge-ttl{font-size:12px;font-weight:800;color:var(--orange);margin-bottom:2px}
  .nudge-sub{font-size:11px;color:var(--ts)}
  .nudge-cta{font-size:11px;font-weight:800;color:var(--lime);white-space:nowrap}

  /* AI insight card */
  .ai-insight-card{background:linear-gradient(135deg,#0a180a,#0a0a1c);border:1px solid ${T.lime}22;border-radius:var(--r3);padding:16px 18px;position:relative;overflow:hidden}
  .aic-orb1{position:absolute;top:-40px;left:-40px;width:160px;height:160px;background:radial-gradient(circle,${T.limeG},transparent 70%);pointer-events:none}
  .aic-orb2{position:absolute;bottom:-30px;right:-30px;width:130px;height:130px;background:radial-gradient(circle,${T.tealDim},transparent 70%);pointer-events:none}
  .aic-hdr{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .aic-orb{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--lime),var(--teal));display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;animation:spin 5s linear infinite}
  .aic-ttl{font-size:11px;font-weight:800;letter-spacing:.7px;text-transform:uppercase;color:var(--lime)}
  .aic-item{display:flex;gap:10px;align-items:flex-start;padding:9px 0;border-top:1px solid rgba(255,255,255,.05)}
  .aic-item:first-of-type{border-top:none;padding-top:0}
  .aic-item-ico{width:24px;height:24px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;margin-top:1px}
  .aic-item-txt{font-size:12px;line-height:1.6;color:rgba(240,240,252,.82)}
  .aic-item-txt strong{font-weight:800;color:var(--lime)}

  /* Scan modal */
  .scan-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(16px);z-index:400;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .25s var(--ease)}
  .scan-sheet{width:430px;background:var(--s);border-radius:var(--r4) var(--r4) 0 0;border:1px solid var(--b);border-bottom:none;animation:slideUp .35s var(--spring);max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
  .scan-handle{width:38px;height:4px;background:var(--b2);border-radius:2px;margin:12px auto 0;flex-shrink:0}
  .scan-camera{background:#000;height:200px;position:relative;overflow:hidden;flex-shrink:0}
  .scan-corner{position:absolute;width:20px;height:20px;border-color:var(--lime);border-style:solid;border-width:0}
  .scan-line{position:absolute;left:10%;right:10%;height:2px;background:linear-gradient(90deg,transparent,var(--lime),transparent);animation:scanLine 2s ease-in-out infinite alternate;box-shadow:0 0 12px var(--lime)}
  .scan-body{padding:18px 22px;flex:1;overflow-y:auto}
  .scan-result-card{background:var(--s2);border:1px solid var(--b2);border-radius:var(--r2);padding:16px;margin-bottom:16px}
  .src-top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .src-emoji{width:46px;height:46px;border-radius:12px;background:var(--s3);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
  .src-name{font-family:var(--fh);font-weight:800;font-size:16px;letter-spacing:-.4px;margin-bottom:3px}
  .src-conf{font-size:10px;font-weight:700;color:var(--lime);background:${T.limeDim};border:1px solid ${T.lime}28;padding:3px 8px;border-radius:12px}
  .src-macros{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .src-macro{background:var(--s3);border-radius:9px;padding:9px 6px;text-align:center}
  .sm-val{font-family:var(--fh);font-weight:800;font-size:15px;letter-spacing:-.4px}
  .sm-lbl{font-size:8px;color:var(--tm);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MEAL IDEAS-SPECIFIC
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .ideas-trigger{background:linear-gradient(135deg,#0c1c0a,#0a0a1e);border:1px solid ${T.lime}20;border-radius:var(--r4);padding:26px 22px;position:relative;overflow:hidden}
  .it-orb1{position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:radial-gradient(circle,${T.limeG},transparent 70%);pointer-events:none}
  .it-orb2{position:absolute;bottom:-40px;left:-40px;width:160px;height:160px;background:radial-gradient(circle,${T.tealDim},transparent 70%);pointer-events:none}
  .it-badge{display:inline-flex;align-items:center;gap:6px;background:${T.limeDim};border:1px solid ${T.lime}22;border-radius:20px;padding:4px 12px;font-size:10px;font-weight:800;letter-spacing:.7px;text-transform:uppercase;color:var(--lime);margin-bottom:14px}
  .it-dot{width:5px;height:5px;border-radius:50%;background:var(--lime);animation:blink 1.5s ease-in-out infinite}
  .it-title{font-family:var(--fh);font-weight:900;font-size:22px;letter-spacing:-.7px;line-height:1.2;margin-bottom:8px}
  .it-title em{color:var(--lime);font-style:normal}
  .it-sub{font-size:13px;color:var(--ts);line-height:1.6;margin-bottom:18px}
  .mrp-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px}
  .mrp{display:flex;align-items:center;gap:5px;background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600}
  .mrp-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

  /* Ideas loading */
  .ideas-loading{display:flex;flex-direction:column;align-items:center;gap:18px;padding:44px 0;animation:fadeIn .4s var(--ease)}
  .il-ring{width:62px;height:62px;border-radius:50%;border:3px solid ${T.limeDim};border-top-color:var(--lime);animation:spin .9s linear infinite;position:relative}
  .il-ring::after{content:'';position:absolute;inset:7px;border-radius:50%;border:2px solid ${T.tealDim};border-bottom-color:var(--teal);animation:spinR 1.4s linear infinite}
  .il-step{display:flex;align-items:center;gap:9px;font-size:12px;color:var(--tm);transition:color .3s}
  .il-step.active{color:var(--lime)}
  .il-step.done{color:var(--green)}
  .ils-dot{width:18px;height:18px;border-radius:50%;border:1.5px solid currentColor;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0}

  /* Idea card */
  .idea-card{background:var(--s);border:1px solid var(--b);border-radius:var(--r3);overflow:hidden;margin-bottom:10px;box-shadow:${T.shadow};transition:all .2s var(--ease);animation:ideaIn .45s var(--spring) both}
  .idea-card:hover{border-color:var(--b2);transform:translateY(-1px);box-shadow:${T.shadowMd}}
  .idea-hdr{padding:16px 16px 12px;display:flex;align-items:flex-start;gap:12px}
  .idea-emoji{width:50px;height:50px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
  .idea-main{flex:1}
  .idea-name{font-family:var(--fh);font-weight:800;font-size:14px;letter-spacing:-.3px;margin-bottom:4px}
  .idea-desc{font-size:12px;color:var(--ts);line-height:1.55;margin-bottom:8px}
  .idea-tags{display:flex;flex-wrap:wrap;gap:4px}
  .idea-tag{font-size:9px;font-weight:800;padding:3px 7px;border-radius:6px;letter-spacing:.3px}
  .idea-right{text-align:right;flex-shrink:0}
  .idea-cal{font-family:var(--fh);font-weight:900;font-size:20px;letter-spacing:-.8px;color:var(--lime);line-height:1}
  .idea-cal-lbl{font-size:9px;color:var(--tm);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
  .idea-conf{display:flex;align-items:center;gap:4px;margin-top:6px;justify-content:flex-end}
  .conf-bar{width:34px;height:3px;background:var(--s3);border-radius:2px;overflow:hidden}
  .conf-fill{height:100%;border-radius:2px}
  .conf-lbl{font-size:8px;font-weight:700}
  .idea-macros{display:flex;border-top:1px solid var(--b)}
  .im-cell{flex:1;padding:10px 6px;text-align:center;border-right:1px solid var(--b)}
  .im-cell:last-child{border-right:none}
  .im-val{font-family:var(--fh);font-weight:800;font-size:14px;letter-spacing:-.4px}
  .im-unit{font-size:8px;color:var(--tm);font-weight:600;text-transform:uppercase;letter-spacing:.4px}
  .im-lbl{font-size:8px;color:var(--tm);text-transform:uppercase;letter-spacing:.4px;margin-top:1px}
  .idea-ings{border-top:1px solid var(--b);padding:12px 16px}
  .ing-toggle{display:flex;align-items:center;justify-content:space-between;cursor:pointer}
  .ing-lbl{font-size:12px;font-weight:700;color:var(--ts)}
  .ing-chev{font-size:11px;color:var(--tm);transition:transform .2s}
  .ing-chev.open{transform:rotate(180deg)}
  .ing-pills{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;animation:fadeIn .25s var(--ease)}
  .ing-pill{font-size:10px;font-weight:500;padding:4px 9px;background:var(--s2);border:1px solid var(--b);border-radius:7px;color:var(--ts)}
  .idea-actions{display:flex;gap:7px;padding:0 12px 12px}
  .ia-btn{flex:1;padding:9px 10px;border-radius:9px;border:1px solid var(--b2);background:var(--s2);color:var(--t);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:4px;font-family:var(--fb)}
  .ia-btn:hover{background:var(--s3)}
  .ia-btn.save{color:var(--lime);border-color:${T.lime}22}
  .ia-btn.save:hover{background:${T.limeDim}}
  .ia-btn.saved{background:${T.limeDim};color:var(--lime);border-color:${T.lime}33}
  .regen-row{display:flex;gap:8px;margin-top:6px}
  .regen-btn{flex:1;background:var(--s);border:1px solid var(--b2);border-radius:var(--r2);padding:12px;font-family:var(--fh);font-weight:700;font-size:12px;cursor:pointer;color:var(--ts);display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s}
  .regen-btn:hover{background:var(--s2);color:var(--t)}
  .regen-btn.primary{background:var(--lime);color:#07070c;border-color:transparent;box-shadow:0 4px 16px ${T.limeG}}
  .regen-btn.primary:hover{opacity:.9}

  /* Pro gate */
  .progate{background:linear-gradient(135deg,${T.violetDim},${T.pinkDim});border:1px solid ${T.violet}28;border-radius:var(--r2);padding:16px;display:flex;gap:12px;align-items:center}
  .pg-ico{font-size:26px;flex-shrink:0}
  .pg-inf{flex:1}
  .pg-ttl{font-family:var(--fh);font-weight:800;font-size:13px;margin-bottom:3px}
  .pg-sub{font-size:11px;color:var(--ts);line-height:1.5}
  .pg-btn{background:var(--violet);color:#fff;border:none;border-radius:var(--r1);padding:9px 13px;font-family:var(--fh);font-weight:800;font-size:12px;cursor:pointer;white-space:nowrap;box-shadow:0 4px 14px rgba(153,119,255,.35);transition:all .2s}
  .pg-btn:hover{opacity:.9;transform:translateY(-1px)}

  /* Limit notice */
  .limit-notice{background:var(--s2);border:1px solid var(--b2);border-radius:var(--r2);padding:13px 15px;display:flex;align-items:center;gap:11px;margin-bottom:12px}
  .ln-ico{font-size:20px}
  .ln-inf{flex:1}
  .ln-ttl{font-size:13px;font-weight:700;margin-bottom:2px}
  .ln-sub{font-size:11px;color:var(--ts)}
  .ln-badge{font-size:10px;font-weight:800;color:var(--orange);background:${T.orangeDim};border:1px solid ${T.orange}25;padding:3px 8px;border-radius:14px;white-space:nowrap}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PROFILE-SPECIFIC
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .phero{background:var(--s);border:1px solid var(--b);border-radius:var(--r4);padding:26px 20px 20px;position:relative;overflow:hidden;box-shadow:${T.shadowMd}}
  .phero-orb1{position:absolute;top:-70px;right:-70px;width:220px;height:220px;background:radial-gradient(circle,${T.limeG},transparent 70%);pointer-events:none}
  .phero-orb2{position:absolute;bottom:-50px;left:-50px;width:180px;height:180px;background:radial-gradient(circle,${T.tealDim},transparent 70%);pointer-events:none}
  .ph-avrow{display:flex;align-items:flex-start;gap:16px;margin-bottom:20px}
  .ph-avwrap{position:relative;flex-shrink:0}
  .ph-av{width:78px;height:78px;border-radius:50%;background:linear-gradient(135deg,var(--lime),var(--teal));display:flex;align-items:center;justify-content:center;font-family:var(--fh);font-weight:900;font-size:26px;color:#07070c;border:3px solid ${T.limeG};box-shadow:0 4px 20px ${T.limeG};cursor:pointer;transition:transform .2s var(--spring)}
  .ph-av:hover{transform:scale(1.05)}
  .ph-av-edit{position:absolute;bottom:0;right:0;width:22px;height:22px;border-radius:50%;background:var(--lime);color:#07070c;border:2px solid var(--bg);display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;font-weight:800}
  .ph-info{flex:1;padding-top:4px}
  .ph-name{font-family:var(--fh);font-weight:900;font-size:22px;letter-spacing:-.6px;margin-bottom:4px}
  .ph-meta{font-size:12px;color:var(--ts);margin-bottom:10px}
  .ph-tags{display:flex;flex-wrap:wrap;gap:6px}
  .ph-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
  .phgc{background:var(--s2);border:1px solid var(--b);border-radius:var(--r2);padding:13px 14px;position:relative;overflow:hidden}
  .phgc-icon{font-size:16px;margin-bottom:7px}
  .phgc-val{font-family:var(--fh);font-weight:800;font-size:17px;letter-spacing:-.5px;margin-bottom:2px}
  .phgc-lbl{font-size:9px;color:var(--ts);text-transform:uppercase;letter-spacing:.6px;font-weight:700}
  .ph-targets{background:var(--s2);border:1px solid var(--b);border-radius:var(--r2);padding:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .ptc{text-align:center}
  .ptcv{font-family:var(--fh);font-weight:800;font-size:15px;letter-spacing:-.4px;line-height:1}
  .ptcu{font-size:9px;color:var(--ts);font-weight:600}
  .ptcl{font-size:9px;color:var(--tm);text-transform:uppercase;letter-spacing:.5px;font-weight:700;margin-top:3px}
  .wlogrow{display:flex;gap:8px;align-items:flex-end;margin-bottom:10px}
  .wloginput{flex:1;background:var(--s2);border:1.5px solid var(--b);border-radius:var(--r2);padding:16px 14px;font-family:var(--fh);font-weight:800;font-size:26px;letter-spacing:-1px;color:var(--t);outline:none;text-align:center;-webkit-appearance:none;transition:border-color .2s}
  .wloginput:focus{border-color:var(--lime);box-shadow:0 0 0 3px ${T.limeDim}}
  .wlogbtn{background:var(--lime);color:#07070c;border:none;border-radius:var(--r2);padding:16px 18px;font-family:var(--fh);font-weight:800;font-size:13px;cursor:pointer;flex-shrink:0;white-space:nowrap;transition:all .2s var(--spring);box-shadow:0 4px 16px ${T.limeG}}
  .wlogbtn:hover{transform:translateY(-2px)}
  .sit{background:var(--s);border:1px solid var(--b);border-radius:var(--r2);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;cursor:pointer;transition:all .2s;animation:fadeUp .4s var(--ease) both}
  .sit:hover{background:var(--s2);border-color:var(--b2)}
  .si-ico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
  .si-inf{flex:1}
  .si-ttl{font-size:13px;font-weight:700;margin-bottom:2px;color:var(--t)}
  .si-sub{font-size:11px;color:var(--ts)}
  .si-r{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--tm)}

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STATS-SPECIFIC
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .stabs{display:flex;gap:6px;padding:14px 20px 0;overflow-x:auto;scrollbar-width:none}
  .stabs::-webkit-scrollbar{display:none}
  .stab{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:8px 14px;border-radius:10px;background:var(--s);border:1px solid var(--b);color:var(--ts);font-family:var(--fh);font-weight:700;font-size:11px;cursor:pointer;transition:all .2s;letter-spacing:.2px}
  .stab.active{background:var(--lime);color:#07070c;border-color:transparent;box-shadow:0 3px 12px ${T.limeG}}
  .ptabs{display:flex;background:var(--s2);border-radius:9px;padding:3px;gap:2px;margin-bottom:16px}
  .ptab{flex:1;padding:7px;border-radius:6px;font-size:11px;font-weight:700;text-align:center;cursor:pointer;transition:all .2s;color:var(--ts)}
  .ptab.active{background:var(--s);color:var(--t);box-shadow:0 1px 6px rgba(0,0,0,.25)}
  .chart-wrap{position:relative;width:100%}
  .chart-svg{width:100%;overflow:visible;display:block}
  .cline{fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:3000;stroke-dashoffset:3000;animation:drawLine 1.6s cubic-bezier(.4,0,.2,1) .25s forwards}
  .cdot{cursor:pointer;transition:r .15s var(--spring)}
  .cdot:hover{r:6}
  .ctooltip{position:absolute;background:var(--t);color:var(--bg);padding:7px 12px;border-radius:10px;font-size:12px;font-weight:700;pointer-events:none;transform:translate(-50%,-110%);white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,.4)}
  .ctooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--t)}
  .cempty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;gap:10px}
  .ce-ico{font-size:36px;opacity:.25}
  .ce-ttl{font-family:var(--fh);font-weight:700;font-size:14px;color:var(--ts)}
  .ce-sub{font-size:12px;color:var(--tm);line-height:1.65;max-width:230px}
  .srwrap{position:relative;flex-shrink:0}
  .srctr{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .srnum{font-family:var(--fh);font-weight:900;font-size:30px;letter-spacing:-1px;line-height:1}
  .srlbl{font-size:9px;color:var(--ts);text-transform:uppercase;letter-spacing:.6px;font-weight:700;margin-top:3px}
  .abar-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--b)}
  .abar-row:last-child{border-bottom:none}
  .abar-ico{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
  .abar-inf{flex:1}
  .abar-nm{font-size:12px;font-weight:700;margin-bottom:5px}
  .abar-track{height:6px;background:var(--s3);border-radius:3px;overflow:hidden}
  .abar-fill{height:100%;border-radius:3px;transition:width 1.4s cubic-bezier(.4,0,.2,1)}
  .abar-r{text-align:right}
  .abar-pct{font-family:var(--fh);font-weight:800;font-size:18px;letter-spacing:-.5px}
  .abar-d{font-size:10px;color:var(--ts);margin-top:2px}
  .ccell{background:var(--s2);border:1px solid var(--b);border-radius:var(--r2);padding:15px 12px;position:relative;overflow:hidden}
  .ccell-glow{position:absolute;bottom:-20px;right:-20px;width:70px;height:70px;border-radius:50%;opacity:.14}
  .cc-ico{font-size:18px;margin-bottom:9px}
  .cc-val{font-family:var(--fh);font-weight:900;font-size:22px;letter-spacing:-.8px;line-height:1}
  .cc-lbl{font-size:9px;color:var(--ts);text-transform:uppercase;letter-spacing:.5px;font-weight:700;margin-top:4px}
  .scal{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .scal-day{aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:7.5px;font-weight:700;cursor:default;transition:transform .15s var(--spring)}
  .scal-day:hover{transform:scale(1.15)}
  .sd-hit{background:var(--lime);color:#07070c}
  .sd-partial{background:${T.limeG.replace('.18','.3')};color:var(--lime)}
  .sd-miss{background:var(--s3);color:var(--tm)}
  .sd-future{background:var(--s2);opacity:.35}
  .sd-today{box-shadow:0 0 0 2px var(--lime)}
  .skpi{flex:1;background:var(--s2);border:1px solid var(--b);border-radius:var(--r2);padding:14px 10px;text-align:center}
  .skpi-ico{font-size:18px;margin-bottom:6px}
  .skpi-val{font-family:var(--fh);font-weight:900;font-size:24px;letter-spacing:-1px;line-height:1}
  .skpi-lbl{font-size:9px;color:var(--ts);text-transform:uppercase;letter-spacing:.5px;font-weight:700;margin-top:4px}
  .aicard{background:linear-gradient(135deg,#0a180a,#0a0a1c);border:1px solid ${T.lime}28;border-radius:var(--r3);overflow:hidden;position:relative}
  .aicard-orb1{position:absolute;top:-50px;left:-50px;width:180px;height:180px;background:radial-gradient(circle,${T.limeG},transparent 70%);pointer-events:none}
  .aicard-orb2{position:absolute;bottom:-40px;right:-40px;width:150px;height:150px;background:radial-gradient(circle,${T.tealDim},transparent 70%);pointer-events:none}
  .aihdr{padding:16px 18px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
  .aiorb{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--lime),var(--teal));display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;animation:spin 6s linear infinite}
  .ai-bdg{font-size:10px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:var(--lime)}
  .ai-sub{font-size:11px;color:var(--tm);margin-top:2px}
  .aibody{padding:16px 18px}
  .ai-item{display:flex;gap:11px;align-items:flex-start;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,.05)}
  .ai-item:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
  .ai-ico{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;margin-top:1px}
  .ai-txt{font-size:13px;line-height:1.6;color:rgba(240,240,252,.85)}
  .ai-txt strong{font-weight:800;color:var(--lime)}
  .ai-load{padding:36px 18px;display:flex;flex-direction:column;align-items:center;gap:14px}
  .ai-spinner{width:34px;height:34px;border-radius:50%;border:2.5px solid ${T.limeDim};border-top-color:var(--lime);animation:spin .8s linear infinite}

  /* Edit modal */
  .moverlay{position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(14px);z-index:500;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .25s var(--ease)}
  .msheet{width:430px;background:var(--s);border-radius:var(--r4) var(--r4) 0 0;border:1px solid var(--b);border-bottom:none;animation:slideUp .35s var(--spring);max-height:92vh;display:flex;flex-direction:column}
  .mhandle{width:38px;height:4px;background:var(--b2);border-radius:2px;margin:12px auto 0;flex-shrink:0}
  .mhdr{padding:18px 22px 0;flex-shrink:0}
  .mtitle{font-family:var(--fh);font-weight:900;font-size:20px;letter-spacing:-.5px}
  .msub{font-size:12px;color:var(--ts);margin-top:3px}
  .mbody{flex:1;overflow-y:auto;padding:18px 22px;scrollbar-width:none}
  .mbody::-webkit-scrollbar{display:none}
  .mfooter{padding:14px 22px 44px;flex-shrink:0;display:flex;gap:10px;border-top:1px solid var(--b)}
  .fstack{display:flex;flex-direction:column;gap:14px}
  .frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .flbl{display:block;font-size:10px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;color:var(--ts);margin-bottom:6px}
  .finp{width:100%;background:var(--s2);border:1.5px solid var(--b);border-radius:var(--r1);padding:12px 13px;font-family:var(--fb);font-size:15px;color:var(--t);outline:none;transition:all .2s;-webkit-appearance:none}
  .finp:focus{border-color:var(--lime);box-shadow:0 0 0 3px ${T.limeDim}}
  .finp::placeholder{color:var(--tm)}
  .fsel{width:100%;background:var(--s2);border:1.5px solid var(--b);border-radius:var(--r1);padding:12px 13px;font-family:var(--fb);font-size:14px;color:var(--t);outline:none;cursor:pointer;-webkit-appearance:none}
  .fsel:focus{border-color:var(--lime)}
  .frecalc{background:${T.limeDim};border:1px solid ${T.lime}33;border-radius:var(--r1);padding:12px 14px;font-size:12px;color:var(--ts);display:flex;gap:8px;align-items:flex-start}
  .lang-sel{background:var(--s);border:1px solid var(--b);border-radius:18px;padding:5px 10px;font-size:11px;font-weight:700;color:var(--ts);cursor:pointer;outline:none;font-family:var(--fb)}
`;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß6  SHARED REUSABLE COMPONENTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/** Animated bar fill */
const ABar = memo(({ pct, color, delay = 0, h = 6 }) => {
  const [w, setW] = useState(0);
  useEffect(() => {
    const t = setTimeout(() => setW(clamp(pct, 0, 100)), 200 + delay);
    return () => clearTimeout(t);
  }, [pct, delay]);
  return (
    <div className="bar-track" style={{ height: h }}>
      <div className="bar-fill" style={{ width: `${w}%`, background: color, transition: `width 1.4s cubic-bezier(.4,0,.2,1) ${delay}ms` }}/>
    </div>
  );
});

/** SVG calorie ring */
const CalRing = memo(({ consumed, goal, size = 134 }) => {
  const [anim, setAnim] = useState(0);
  const R = 52, C = 2 * Math.PI * R;
  const pct = clamp(consumed / (goal || 1), 0, 1.06);
  const over = consumed > goal;
  useEffect(() => { const t = setTimeout(() => setAnim(pct), 120); return () => clearTimeout(t); }, [pct]);
  return (
    <svg width={size} height={size} viewBox="0 0 116 116" style={{ flexShrink: 0 }}>
      <defs>
        <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#aaee22"/><stop offset="100%" stopColor="#22eebb"/>
        </linearGradient>
        <filter id="rglow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <circle cx="58" cy="58" r={R} fill="none" stroke="rgba(255,255,255,.04)" strokeWidth="8"/>
      <circle cx="58" cy="58" r="40" fill="none" stroke="rgba(255,255,255,.025)" strokeWidth="3"/>
      {consumed === 0
        ? <circle cx="58" cy="58" r={R} fill="none" stroke="rgba(255,255,255,.04)" strokeWidth="8" strokeDasharray="8 12" transform="rotate(-90 58 58)"/>
        : <circle cx="58" cy="58" r={R} fill="none" stroke={over ? '#ee3333' : 'url(#rg)'} strokeWidth="8" strokeLinecap="round"
            strokeDasharray={`${anim * C} ${C}`} transform="rotate(-90 58 58)"
            style={{ transition: 'stroke-dasharray 1.5s cubic-bezier(.4,0,.2,1)', filter: over ? 'none' : 'url(#rglow)' }}/>
      }
    </svg>
  );
});

/** SVG line chart (Stats) */
const LineChart = memo(({ data, color, unit = 'kg', W = 380, H = 140, goalVal, isEmpty }) => {
  const [tip, setTip] = useState(null);
  const ref = useRef();
  if (isEmpty || !data || data.length < 2) {
    return (
      <div className="cempty">
        <div className="ce-ico">üìà</div>
        <div className="ce-ttl">No data yet</div>
        <div className="ce-sub">Start logging daily to see your progress chart animate to life.</div>
      </div>
    );
  }
  const vals = data.map(d => d.value ?? d.weight ?? 0);
  const allV = goalVal ? [...vals, goalVal] : vals;
  const minV = Math.min(...allV) * .993, maxV = Math.max(...allV) * 1.007;
  const range = maxV - minV || 1;
  const PAD = { l:32, r:14, t:16, b:26 };
  const cW = W - PAD.l - PAD.r, cH = H - PAD.t - PAD.b;
  const px = i => PAD.l + i / (data.length - 1) * cW;
  const py = v => PAD.t + cH - (v - minV) / range * cH;
  const pts = data.map((_, i) => `${px(i)},${py(vals[i])}`).join(' ');
  const area = `${PAD.l},${PAD.t+cH} ${data.map((_,i)=>`${px(i)},${py(vals[i])}`).join(' ')} ${PAD.l+cW},${PAD.t+cH}`;
  const yT = [minV, minV + range / 2, maxV];
  const gId = `g${color.replace(/[^a-z0-9]/gi, '')}`;
  return (
    <div className="chart-wrap" ref={ref}>
      <svg viewBox={`0 0 ${W} ${H}`} className="chart-svg" style={{ height: H }}>
        <defs>
          <linearGradient id={gId} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor={color} stopOpacity=".45"/>
            <stop offset="100%" stopColor={color} stopOpacity="0"/>
          </linearGradient>
          <filter id={`glow_${gId}`}><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        {yT.map((v, i) => (
          <g key={i}>
            <line x1={PAD.l} y1={py(v)} x2={PAD.l+cW} y2={py(v)} stroke="rgba(255,255,255,.04)" strokeWidth="1"/>
            <text x={PAD.l-4} y={py(v)+4} fontSize="9" fill="var(--tm)" textAnchor="end">{Math.round(v*10)/10}</text>
          </g>
        ))}
        {goalVal && <>
          <line x1={PAD.l} y1={py(goalVal)} x2={PAD.l+cW} y2={py(goalVal)} stroke={color} strokeWidth="1.5" strokeDasharray="5 4" opacity=".45"/>
          <text x={PAD.l+cW+2} y={py(goalVal)+4} fontSize="9" fill={color} opacity=".6">Goal</text>
        </>}
        {data.filter((_,i)=>i===0||i===data.length-1||i%Math.ceil(data.length/4)===0).map(d=>{
          const i=data.indexOf(d);
          return <text key={d.date} x={px(i)} y={H-2} fontSize="9" fill="var(--tm)" textAnchor="middle">{new Date(d.date).toLocaleDateString('en',{month:'short',day:'numeric'})}</text>;
        })}
        <polygon points={area} fill={`url(#${gId})`} opacity=".15"/>
        <polyline points={pts} className="cline" stroke={color} style={{filter:`url(#glow_${gId})`}}/>
        {data.map((d, i) => (
          <circle key={d.date} cx={px(i)} cy={py(vals[i])} r="3.5" fill={color} className="cdot"
            onMouseEnter={() => setTip({ x:`${px(i)/W*100}%`, y:`${py(vals[i])/H*100}%`, label:`${vals[i]}${unit}`, date:new Date(d.date).toLocaleDateString('en',{month:'short',day:'numeric'}) })}
            onMouseLeave={() => setTip(null)}/>
        ))}
      </svg>
      {tip && <div className="ctooltip" style={{ left:tip.x, top:tip.y }}>{tip.label} ¬∑ {tip.date}</div>}
    </div>
  );
});

/** Macro Adherence Score Ring (Stats) */
const ScoreRing = memo(({ score, size = 118, T: Tok }) => {
  const [a, setA] = useState(0);
  const R = 46, C = 2 * Math.PI * R;
  useEffect(() => { const t = setTimeout(() => setA(score), 150); return () => clearTimeout(t); }, [score]);
  const col = a >= 85 ? (Tok||DARK).green : a >= 65 ? (Tok||DARK).lime : a >= 45 ? (Tok||DARK).orange : (Tok||DARK).red;
  return (
    <div className="srwrap" style={{ width: size, height: size }}>
      <svg width={size} height={size} viewBox="0 0 106 106">
        <defs>
          <linearGradient id="srg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor={col}/><stop offset="100%" stopColor={(Tok||DARK).teal}/>
          </linearGradient>
          <filter id="srglow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <circle cx="53" cy="53" r={R} fill="none" stroke="rgba(255,255,255,.05)" strokeWidth="8"/>
        <circle cx="53" cy="53" r={R} fill="none" stroke="url(#srg)" strokeWidth="8" strokeLinecap="round"
          transform="rotate(-90 53 53)" strokeDasharray={`${a/100*C} ${C}`}
          style={{ transition:'stroke-dasharray 1.4s cubic-bezier(.4,0,.2,1)', filter:'url(#srglow)' }}/>
      </svg>
      <div className="srctr">
        <div className="srnum" style={{ color: col }}>{Math.round(a)}</div>
        <div className="srlbl">score</div>
      </div>
    </div>
  );
});

/** Streak Calendar Heatmap */
const StreakCal = memo(({ dailyLogs, target }) => {
  const today = new Date(); today.setHours(0,0,0,0);
  const cells = Array.from({ length:35 }, (_,i) => {
    const d = new Date(today); d.setDate(today.getDate() - 34 + i);
    const ds = d.toISOString().split('T')[0];
    const log = dailyLogs.find(l => l.date === ds);
    const isFuture = d > today, isToday = d.getTime() === today.getTime();
    let cls = 'sd-miss';
    if (isFuture) cls = 'sd-future';
    else if (log) { const r = log.calories / target; cls = r >= .85 && r <= 1.15 ? 'sd-hit' : r >= .68 ? 'sd-partial' : 'sd-miss'; }
    return { ds, cls, isToday, day: d.getDate() };
  });
  return (
    <div className="scal">
      {cells.map(c => <div key={c.ds} className={`scal-day ${c.cls} ${c.isToday?'sd-today':''}`} title={c.ds}>{c.day}</div>)}
    </div>
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß7  EDIT PROFILE MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const EditModal = memo(({ user, onSave, onClose, T: Tok }) => {
  const [f, setF] = useState({
    name:user.name, age:user.age, gender:user.gender,
    heightCm:user.heightCm, weightKg:user.weightKg,
    targetWeightKg:user.targetWeightKg, goal_type:user.goal_type,
    activity:user.activity, diet:user.diet,
  });
  const [saving, setSaving] = useState(false);
  const upd = (k, v) => setF(p => ({ ...p, [k]: v }));
  const wChg = parseFloat(f.weightKg) !== user.weightKg || f.goal_type !== user.goal_type || f.activity !== user.activity || f.diet !== user.diet;
  const newBMR = calcBMR(+f.age, f.gender, +f.weightKg, +f.heightCm);
  const newTDEE = calcTDEE(newBMR, f.activity);
  const newTarget = calcTarget(newTDEE, f.goal_type);
  const newMacros = calcMacros(newTarget, f.diet);

  const handleSave = async () => {
    setSaving(true);
    await new Promise(r => setTimeout(r, 900));
    onSave({ ...f, weightKg:+f.weightKg, calorie_target:newTarget, protein_target:newMacros.protein, carb_target:newMacros.carbs, fat_target:newMacros.fat });
    setSaving(false); onClose();
  };

  return (
    <div className="moverlay" onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="msheet">
        <div className="mhandle"/>
        <div className="mhdr">
          <div className="mtitle">Edit Profile</div>
          <div className="msub">Changes auto-recalculate BMR, TDEE & macro targets</div>
        </div>
        <div className="mbody">
          <div className="fstack">
            <div><label className="flbl">Full Name</label><input className="finp" value={f.name} onChange={e=>upd('name',e.target.value)}/></div>
            <div className="frow">
              <div><label className="flbl">Age</label><input className="finp" type="number" value={f.age} onChange={e=>upd('age',e.target.value)} min={16} max={80}/></div>
              <div><label className="flbl">Gender</label>
                <select className="fsel" value={f.gender} onChange={e=>upd('gender',e.target.value)}>
                  <option value="male">Male</option><option value="female">Female</option><option value="other">Other</option>
                </select>
              </div>
            </div>
            <div className="frow">
              <div><label className="flbl">Height (cm)</label><input className="finp" type="number" value={f.heightCm} onChange={e=>upd('heightCm',e.target.value)}/></div>
              <div><label className="flbl">Weight (kg)</label><input className="finp" type="number" step=".1" value={f.weightKg} onChange={e=>upd('weightKg',e.target.value)}/></div>
            </div>
            <div className="frow">
              <div><label className="flbl">Target (kg)</label><input className="finp" type="number" step=".1" value={f.targetWeightKg} onChange={e=>upd('targetWeightKg',e.target.value)}/></div>
              <div><label className="flbl">Goal</label>
                <select className="fsel" value={f.goal_type} onChange={e=>upd('goal_type',e.target.value)}>
                  <option value="lose">Lose Weight</option><option value="gain">Gain Muscle</option><option value="maintain">Maintain</option>
                </select>
              </div>
            </div>
            <div><label className="flbl">Activity Level</label>
              <select className="fsel" value={f.activity} onChange={e=>upd('activity',e.target.value)}>
                <option value="sedentary">Sedentary</option><option value="light">Light (1‚Äì3√ó/wk)</option>
                <option value="moderate">Moderate (3‚Äì5√ó/wk)</option><option value="active">Very Active (6‚Äì7√ó/wk)</option>
              </select>
            </div>
            <div><label className="flbl">Diet Preference</label>
              <select className="fsel" value={f.diet} onChange={e=>upd('diet',e.target.value)}>
                <option value="highprotein">High Protein (40/35/25)</option>
                <option value="balanced">Balanced (30/40/30)</option>
                <option value="lowcarb">Low Carb (40/20/40)</option>
                <option value="vegetarian">Vegetarian (25/50/25)</option>
              </select>
            </div>
            {wChg && (
              <div className="frecalc">
                <span style={{fontSize:14,flexShrink:0}}>‚ö°</span>
                <div>
                  <div style={{fontWeight:800,fontSize:12,marginBottom:4}}>Auto-recalculated</div>
                  <div style={{fontSize:11,color:'var(--ts)'}}>
                    BMR: <strong>{newBMR}</strong> ¬∑ TDEE: <strong>{newTDEE}</strong> ¬∑ Daily: <strong>{newTarget} kcal</strong><br/>
                    P: <strong>{newMacros.protein}g</strong> ¬∑ C: <strong>{newMacros.carbs}g</strong> ¬∑ F: <strong>{newMacros.fat}g</strong>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
        <div className="mfooter">
          <button className="btn-ghost" style={{flex:1}} onClick={onClose}>Cancel</button>
          <button className="btn-pri" style={{flex:2}} onClick={handleSave} disabled={saving}>
            {saving
              ? <><div style={{width:15,height:15,borderRadius:'50%',border:'2px solid rgba(7,7,12,.25)',borderTopColor:'#07070c',animation:'spin .7s linear infinite'}}/> Saving‚Ä¶</>
              : '‚úì Save Changes'}
          </button>
        </div>
      </div>
    </div>
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß8  AI FUNCTIONS  (Claude API calls)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/** Meal ideas generator */
async function generateMealIdeas(remaining, goalType, diet, plan) {
  const prompt = `You are a certified sports nutritionist AI. Generate exactly 3 personalized meal ideas.

USER PROFILE:
- Goal: ${goalType === 'lose' ? 'Weight Loss' : goalType === 'gain' ? 'Muscle Gain' : 'Maintenance'}
- Diet: ${diet}
- Plan: ${plan}

REMAINING MACROS FOR TODAY:
- Calories: ${Math.max(0, remaining.calories)} kcal
- Protein: ${Math.max(0, remaining.protein)}g
- Carbs: ${Math.max(0, remaining.carbs)}g
- Fat: ${Math.max(0, remaining.fat)}g

RULES:
1. Each meal must fit within remaining macros (don't exceed)
2. Prioritize protein if it's the biggest gap
3. Calories must be realistic; no hallucination
4. Tags: pick 1-3 from: High Protein, Low Carb, Balanced, Low Fat, Quick, Filling
5. Confidence: 0-100, how well this fits the user's remaining macros

Return ONLY valid JSON array (no markdown):
[{"name":"Meal name","description":"1-2 sentence description","calories":420,"protein":38,"carbs":32,"fat":12,"emoji":"üçó","tags":["High Protein","Quick"],"confidence":94,"ingredients":["150g chicken breast","1 cup brown rice","spinach","olive oil"]}]`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:1000, messages:[{role:'user',content:prompt}] }),
    });
    const data = await res.json();
    const raw = data.content?.map(b => b.text||'').join('') || '';
    return JSON.parse(raw.replace(/```json|```/g,'').trim());
  } catch {
    const cal = Math.min(Math.max(remaining.calories, 200), 700);
    const pro = Math.min(Math.max(remaining.protein, 20), 60);
    return [
      { name:'High-Protein Chicken Bowl', description:'Grilled chicken breast over brown rice with roasted broccoli and sesame sauce. Fast, filling, perfectly balanced.', calories:Math.round(cal*.72), protein:Math.round(pro*.88), carbs:Math.round(cal*.72*.35/4), fat:14, emoji:'üçó', tags:['High Protein','Filling'], confidence:95, ingredients:['150g chicken breast','¬æ cup brown rice','1 cup broccoli','1 tbsp sesame oil','soy sauce'] },
      { name:'Tuna Avocado Lettuce Cups', description:'Low-carb butter lettuce cups filled with seasoned tuna, creamy avocado and lemon zest. Ready in 5 minutes.', calories:Math.round(cal*.42), protein:Math.round(pro*.62), carbs:8, fat:15, emoji:'üåø', tags:['Low Carb','Quick'], confidence:87, ingredients:['1 can tuna','¬Ω avocado','butter lettuce','cucumber','lemon','capers'] },
      { name:'Protein Smoothie Bowl', description:'Thick frozen banana-berry base blended with protein powder, topped with granola and almond butter.', calories:Math.round(cal*.55), protein:Math.round(pro*.52), carbs:Math.round(cal*.55*.45/4), fat:9, emoji:'ü´ê', tags:['Balanced','Quick'], confidence:80, ingredients:['1 banana','1 cup mixed berries','1 scoop protein powder','¬Ω cup almond milk','2 tbsp granola','1 tbsp almond butter'] },
    ];
  }
}

/** Weekly AI progress summary */
async function getAISummary(user, weightLogs, dailyLogs) {
  const wStart = weightLogs[0]?.weight ?? 0;
  const wEnd = weightLogs[weightLogs.length-1]?.weight ?? 0;
  const delta = (wEnd - wStart).toFixed(1);
  const withinTarget = dailyLogs.filter(l => { const r=l.calories/user.calorie_target; return r>=.85&&r<=1.15; }).length;
  const protPct = Math.round(dailyLogs.slice(-14).reduce((s,l) => s+(l.protein/user.protein_target),0)/14*100);

  const prompt = `You are a supportive, data-driven nutrition coach. Generate a concise weekly progress summary.

USER DATA:
- Goal: ${user.goal_type==='lose'?'Weight Loss':'Muscle Gain'}
- Weight change (6 weeks): ${delta > 0?'+':''}${delta}kg (${wStart}‚Üí${wEnd}kg)
- Target: ${user.targetWeightKg}kg
- Days within calorie target: ${withinTarget}/${dailyLogs.length}
- Avg protein adherence (14d): ${protPct}%
- Current streak: ${user.streak} ¬∑ Longest: ${user.longestStreak}

Return ONLY valid JSON (no markdown):
{"summary_title":"5-word motivating headline","period":"Last 6 weeks","insights":[{"type":"progress","icon":"üìâ","text":"sentence with <strong>numbers bolded</strong>"},{"type":"nutrition","icon":"ü•©","text":"..."},{"type":"streak","icon":"üî•","text":"..."},{"type":"tip","icon":"üí°","text":"one actionable tip"}]}`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,messages:[{role:'user',content:prompt}]}),
    });
    const data = await res.json();
    const raw = data.content?.map(b=>b.text||'').join('') || '';
    return JSON.parse(raw.replace(/```json|```/g,'').trim());
  } catch {
    const d = parseFloat(delta);
    return {
      summary_title: d < 0 ? "Solid progress, keep building" : "Consistency is your superpower",
      period: "Last 6 weeks",
      insights: [
        { type:'progress', icon:'üìâ', text:`Your weight changed <strong>${Math.abs(delta)}kg</strong> over 6 weeks ‚Äî ${d<0?'a steady deficit driving real results.':'lean surplus for muscle growth.'}` },
        { type:'nutrition', icon:'ü•©', text:`Protein adherence averaged <strong>${protPct}%</strong>. ${protPct>=80?'Excellent ‚Äî this protects muscle.':'Add one high-protein snack daily.'}` },
        { type:'streak', icon:'üî•', text:`<strong>${user.streak}-day current streak</strong>. Personal best: <strong>${user.longestStreak} days</strong>.` },
        { type:'tip', icon:'üí°', text:`You hit calorie target <strong>${withinTarget} of ${dailyLogs.length}</strong> days. Sunday meal prep could push this past 80%.` },
      ],
    };
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß9  IDEA CARD COMPONENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const IdeaCard = memo(({ idea, index, onToast }) => {
  const [saved, setSaved] = useState(false);
  const [showIng, setShowIng] = useState(false);
  const tagStyle = {
    'High Protein':{ bg:DARK.tealDim,   color:DARK.teal,   bdr:'rgba(34,238,187,.2)' },
    'Low Carb':    { bg:DARK.limeDim,   color:DARK.lime,   bdr:'rgba(170,238,34,.2)' },
    'Balanced':    { bg:DARK.violetDim, color:DARK.violet, bdr:'rgba(153,119,255,.2)' },
    'Low Fat':     { bg:DARK.pinkDim,   color:DARK.pink,   bdr:'rgba(238,34,170,.2)' },
    'Quick':       { bg:DARK.orangeDim, color:DARK.orange, bdr:'rgba(238,153,34,.2)' },
    'Filling':     { bg:DARK.cyanDim,   color:DARK.cyan,   bdr:'rgba(34,204,238,.2)' },
  };
  const bgPalette = [
    `linear-gradient(135deg,${DARK.limeDim},rgba(34,238,187,.05))`,
    `linear-gradient(135deg,${DARK.tealDim},rgba(153,119,255,.05))`,
    `linear-gradient(135deg,${DARK.violetDim},rgba(238,34,170,.05))`,
  ];
  const confColor = idea.confidence >= 90 ? DARK.green : idea.confidence >= 75 ? DARK.lime : DARK.orange;
  return (
    <div className="idea-card" style={{ animationDelay:`${index*.12}s` }}>
      <div className="idea-hdr">
        <div className="idea-emoji" style={{ background:bgPalette[index%3] }}>{idea.emoji}</div>
        <div className="idea-main">
          <div className="idea-name">{idea.name}</div>
          <div className="idea-desc">{idea.description}</div>
          <div className="idea-tags">
            {idea.tags?.map(tag => {
              const s = tagStyle[tag] || tagStyle['Balanced'];
              return <span key={tag} className="idea-tag" style={{ background:s.bg, color:s.color, border:`1px solid ${s.bdr}` }}>{tag}</span>;
            })}
          </div>
        </div>
        <div className="idea-right">
          <div className="idea-cal">{idea.calories}</div>
          <div className="idea-cal-lbl">kcal</div>
          <div className="idea-conf">
            <div className="conf-bar"><div className="conf-fill" style={{ width:`${idea.confidence}%`,background:confColor }}/></div>
            <div className="conf-lbl" style={{ color:confColor }}>{idea.confidence}%</div>
          </div>
        </div>
      </div>
      <div className="idea-macros">
        {[{l:'Protein',v:idea.protein,c:DARK.teal},{l:'Carbs',v:idea.carbs,c:DARK.lime},{l:'Fat',v:idea.fat,c:DARK.orange}].map(m=>(
          <div key={m.l} className="im-cell">
            <div className="im-val" style={{color:m.c}}>{m.v}</div>
            <div className="im-unit">g</div>
            <div className="im-lbl">{m.l}</div>
          </div>
        ))}
      </div>
      {idea.ingredients?.length > 0 && (
        <div className="idea-ings">
          <div className="ing-toggle" onClick={()=>setShowIng(v=>!v)}>
            <div className="ing-lbl">üßæ Ingredients ({idea.ingredients.length})</div>
            <div className={`ing-chev ${showIng?'open':''}`}>‚ñæ</div>
          </div>
          {showIng && <div className="ing-pills">{idea.ingredients.map(i=><span key={i} className="ing-pill">{i}</span>)}</div>}
        </div>
      )}
      <div className="idea-actions">
        <button className={`ia-btn save ${saved?'saved':''}`} onClick={()=>{setSaved(true);onToast('‚ô° Saved to favorites');}}>
          {saved?'‚úì Saved':'‚ô° Save'}
        </button>
        <button className="ia-btn" onClick={()=>onToast('‚úé Meal editor coming soon')}>‚úé Modify</button>
        <button className="ia-btn" onClick={()=>onToast('‚úì Added to today\'s plan')}>+ Log It</button>
      </div>
    </div>
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß10  SCAN MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ScanModal = memo(({ onAdd, onClose, mealTypes }) => {
  const [phase, setPhase] = useState('scanning'); // scanning | result
  const [result, setResult] = useState(null);
  const [mealType, setMealType] = useState(mealTypes[0] || 'breakfast');

  useEffect(() => {
    const t = setTimeout(() => {
      const pick = SCAN_POOL[Math.floor(Math.random() * SCAN_POOL.length)];
      setResult(pick); setPhase('result');
    }, 2000);
    return () => clearTimeout(t);
  }, []);

  return (
    <div className="scan-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="scan-sheet">
        <div className="scan-handle"/>
        {/* Camera view */}
        <div className="scan-camera">
          <div style={{position:'absolute',inset:0,background:'linear-gradient(135deg,#0a1a0a,#0a0a14)',display:'flex',alignItems:'center',justifyContent:'center'}}>
            <div style={{fontSize:48,opacity:.3}}>üì∑</div>
          </div>
          {/* Corner brackets */}
          {[[{top:12,left:12},{borderTopWidth:2,borderLeftWidth:2}],[{top:12,right:12},{borderTopWidth:2,borderRightWidth:2}],[{bottom:12,left:12},{borderBottomWidth:2,borderLeftWidth:2}],[{bottom:12,right:12},{borderBottomWidth:2,borderRightWidth:2}]].map(([pos,bdr],i)=>(
            <div key={i} className="scan-corner" style={{...pos,...bdr,borderColor:DARK.lime}}/>
          ))}
          {phase === 'scanning' && <div className="scan-line"/>}
          {phase === 'scanning' && (
            <div style={{position:'absolute',bottom:12,left:0,right:0,textAlign:'center',fontSize:11,fontWeight:700,color:DARK.lime,letterSpacing:'.5px',textTransform:'uppercase'}}>
              Analyzing food‚Ä¶
            </div>
          )}
        </div>
        <div className="scan-body">
          {phase === 'scanning' ? (
            <div style={{padding:'24px 0',textAlign:'center'}}>
              <div style={{width:36,height:36,borderRadius:'50%',border:`2.5px solid ${DARK.limeDim}`,borderTopColor:DARK.lime,animation:'spin .8s linear infinite',margin:'0 auto 14px'}}/>
              <div style={{fontFamily:'var(--fh)',fontWeight:700,fontSize:15,marginBottom:4}}>Scanning your meal‚Ä¶</div>
              <div style={{fontSize:12,color:DARK.sec}}>AI is identifying ingredients and calculating macros</div>
            </div>
          ) : (
            <>
              <div className="scan-result-card">
                <div className="src-top">
                  <div className="src-emoji">{result?.emoji}</div>
                  <div>
                    <div className="src-name">{result?.name}</div>
                    <span className="src-conf">97% confidence</span>
                  </div>
                </div>
                <div className="src-macros">
                  {[{l:'Calories',v:result?.calories,c:DARK.lime},{l:'Protein',v:`${result?.protein}g`,c:DARK.teal},{l:'Carbs',v:`${result?.carbs}g`,c:DARK.orange},{l:'Fat',v:`${result?.fat}g`,c:DARK.pink}].map(m=>(
                    <div key={m.l} className="src-macro">
                      <div className="sm-val" style={{color:m.c}}>{m.v}</div>
                      <div className="sm-lbl">{m.l}</div>
                    </div>
                  ))}
                </div>
              </div>
              {/* Meal type selector */}
              <div style={{marginBottom:14}}>
                <div style={{fontSize:10,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',color:DARK.sec,marginBottom:8}}>Add to meal</div>
                <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                  {['breakfast','lunch','dinner','snacks'].map(t=>(
                    <div key={t} onClick={()=>setMealType(t)} style={{padding:'7px 13px',borderRadius:9,background:mealType===t?DARK.lime:DARK.surf2,color:mealType===t?'#07070c':DARK.sec,border:`1px solid ${mealType===t?'transparent':DARK.bdr}`,fontSize:12,fontWeight:700,cursor:'pointer',transition:'all .2s',fontFamily:'var(--fh)'}}>
                      {MEAL_LABELS[t]}
                    </div>
                  ))}
                </div>
              </div>
              <button className="btn-pri" onClick={()=>{ onAdd(result, mealType); onClose(); }}>
                + Add to {MEAL_LABELS[mealType]}
              </button>
              <button className="btn-ghost" style={{marginTop:8}} onClick={()=>{setPhase('scanning');setResult(null);setTimeout(()=>{const p=SCAN_POOL[Math.floor(Math.random()*SCAN_POOL.length)];setResult(p);setPhase('result');},2000);}}>
                ‚Ü∫ Scan Again
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß12  LOGIN / ONBOARDING SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LoginScreen = memo(({ onLogin, T, theme, setTheme, lang, setLang }) => {
  const [tab,     setTab]     = useState('login');
  const [email,   setEmail]   = useState('');
  const [pw,      setPw]      = useState('');
  const [name,    setName]    = useState('');
  const [showPw,  setShowPw]  = useState(false);
  const [loading, setLoading] = useState(false);
  const [err,     setErr]     = useState('');
  const [step,    setStep]    = useState(0);
  const [ob, setOb] = useState({ goal:'lose', activity:'moderate', diet:'highprotein', age:28, gender:'male', heightCm:175, weightKg:80, targetWeightKg:72 });
  const upd = (k,v) => setOb(p=>({...p,[k]:v}));
  const obBMR    = calcBMR(ob.age, ob.gender, ob.weightKg, ob.heightCm);
  const obTDEE   = calcTDEE(obBMR, ob.activity);
  const obTarget = calcTarget(obTDEE, ob.goal);
  const obMacros = calcMacros(obTarget, ob.diet);

  const handleAuth = async () => {
    if (!email || !pw) { setErr('Please fill all fields'); return; }
    if (tab==='register' && !name) { setErr('Enter your name'); return; }
    setErr(''); setLoading(true);
    await new Promise(r => setTimeout(r, 1100));
    setLoading(false);
    if (tab === 'register') { setStep(1); }
    else { onLogin({ ...INIT_USER, plan:'pro' }); }
  };

  const handleDone = () => {
    onLogin({ name:name||'New User', age:ob.age, gender:ob.gender, heightCm:ob.heightCm,
      weightKg:ob.weightKg, targetWeightKg:ob.targetWeightKg, goal_type:ob.goal,
      activity:ob.activity, diet:ob.diet, plan:'free', calorie_target:obTarget,
      protein_target:obMacros.protein, carb_target:obMacros.carbs, fat_target:obMacros.fat, streak:0, longestStreak:0 });
  };

  const inp = { display:'block', width:'100%', boxSizing:'border-box', background:T.surf2,
    border:`1.5px solid ${T.bdr}`, borderRadius:14, padding:'13px 14px',
    fontFamily:'var(--fb)', fontSize:15, color:T.text, outline:'none', transition:'border-color .2s' };

  if (step >= 1) return (
    <>
      <style>{makeCSS(T)}</style>
      <div className="shell">
        <div className="scroll" style={{padding:'52px 22px 40px'}}>
          <div style={{display:'flex',gap:5,marginBottom:28}}>
            {[1,2,3,4].map(s=><div key={s} style={{flex:1,height:3,borderRadius:2,background:s<=step?T.lime:T.surf3,transition:'background .3s'}}/>)}
          </div>
          <div style={{fontSize:10,color:T.sec,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',marginBottom:6}}>Step {step} of 4</div>
          <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:26,letterSpacing:'-1px',marginBottom:8,lineHeight:1.15,color:T.text}}>
            {step===1&&<>What&apos;s your <span style={{color:T.lime}}>goal?</span></>}
            {step===2&&<>Your <span style={{color:T.lime}}>body</span> stats</>}
            {step===3&&<>Activity & <span style={{color:T.lime}}>diet</span></>}
            {step===4&&<>üéâ All set, <span style={{color:T.lime}}>{(name||'friend').split(' ')[0]}!</span></>}
          </div>
          <div style={{fontSize:13,color:T.sec,marginBottom:24,lineHeight:1.65}}>
            {step===1&&'Your goal determines your calorie target and macro split.'}
            {step===2&&'Used to calculate your BMR with the Mifflin-St Jeor formula.'}
            {step===3&&'We calculate your TDEE and personalize your daily macros.'}
            {step===4&&`Daily target: ${obTarget} kcal ¬∑ P:${obMacros.protein}g C:${obMacros.carbs}g F:${obMacros.fat}g`}
          </div>

          {step===1&&<div style={{display:'flex',flexDirection:'column',gap:10}}>
            {[{v:'lose',e:'üî•',t:'Lose Weight',s:'Calorie deficit ¬∑ ‚àí500 kcal/day'},
              {v:'maintain',e:'‚öñÔ∏è',t:'Maintain Weight',s:'TDEE maintenance calories'},
              {v:'gain',e:'üí™',t:'Gain Muscle',s:'Calorie surplus ¬∑ +300 kcal/day'}].map(g=>(
              <div key={g.v} onClick={()=>upd('goal',g.v)} style={{display:'flex',alignItems:'center',gap:14,padding:'15px 18px',borderRadius:20,border:`2px solid ${ob.goal===g.v?T.lime:T.bdr}`,background:ob.goal===g.v?T.limeDim:T.surf,cursor:'pointer',transition:'all .2s'}}>
                <span style={{fontSize:24,width:34,textAlign:'center'}}>{g.e}</span>
                <div style={{flex:1}}><div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:15,color:ob.goal===g.v?T.lime:T.text,marginBottom:2}}>{g.t}</div><div style={{fontSize:12,color:T.sec}}>{g.s}</div></div>
                {ob.goal===g.v&&<div style={{width:22,height:22,borderRadius:'50%',background:T.lime,display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,color:'#07070c',fontWeight:900}}>‚úì</div>}
              </div>
            ))}
          </div>}

          {step===2&&<div style={{display:'flex',flexDirection:'column',gap:14}}>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
              {[{k:'age',l:'Age',u:'yrs'},{k:'weightKg',l:'Weight',u:'kg'},{k:'targetWeightKg',l:'Target',u:'kg'},{k:'heightCm',l:'Height',u:'cm'}].map(f=>(
                <div key={f.k}>
                  <div style={{fontSize:10,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',color:T.sec,marginBottom:6}}>{f.l}</div>
                  <div style={{display:'flex',background:T.surf2,border:`1.5px solid ${T.bdr}`,borderRadius:14,overflow:'hidden',alignItems:'center'}}>
                    <input type="number" value={ob[f.k]} onChange={e=>upd(f.k,parseFloat(e.target.value)||0)} style={{flex:1,background:'transparent',border:'none',padding:'12px',fontFamily:'var(--fh)',fontWeight:800,fontSize:18,color:T.text,outline:'none'}}/>
                    <span style={{padding:'0 12px',color:T.sec,fontSize:11,fontWeight:700,flexShrink:0}}>{f.u}</span>
                  </div>
                </div>
              ))}
            </div>
            <div>
              <div style={{fontSize:10,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',color:T.sec,marginBottom:8}}>Gender</div>
              <div style={{display:'flex',gap:8}}>
                {[{v:'male',l:'Male'},{v:'female',l:'Female'},{v:'other',l:'Other'}].map(g=>(
                  <div key={g.v} onClick={()=>upd('gender',g.v)} style={{flex:1,padding:'11px',borderRadius:13,border:`2px solid ${ob.gender===g.v?T.lime:T.bdr}`,background:ob.gender===g.v?T.limeDim:T.surf,textAlign:'center',cursor:'pointer',fontSize:13,fontWeight:700,color:ob.gender===g.v?T.lime:T.sec,transition:'all .15s'}}>{g.l}</div>
                ))}
              </div>
            </div>
          </div>}

          {step===3&&<div style={{display:'flex',flexDirection:'column',gap:16}}>
            <div>
              <div style={{fontSize:11,fontWeight:800,color:T.sec,marginBottom:10,textTransform:'uppercase',letterSpacing:'.5px'}}>Activity Level</div>
              {[{v:'sedentary',e:'ü™ë',t:'Sedentary',s:'Little or no exercise'},{v:'light',e:'üö∂',t:'Light Active',s:'1‚Äì3 workouts/week'},{v:'moderate',e:'üèÉ',t:'Moderate',s:'3‚Äì5 workouts/week'},{v:'active',e:'‚ö°',t:'Very Active',s:'6‚Äì7 workouts/week'}].map(a=>(
                <div key={a.v} onClick={()=>upd('activity',a.v)} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 14px',borderRadius:14,border:`1.5px solid ${ob.activity===a.v?T.lime:T.bdr}`,background:ob.activity===a.v?T.limeDim:T.surf,cursor:'pointer',marginBottom:8,transition:'all .15s'}}>
                  <span style={{fontSize:20}}>{a.e}</span>
                  <div style={{flex:1}}><div style={{fontSize:13,fontWeight:700,color:ob.activity===a.v?T.lime:T.text}}>{a.t}</div><div style={{fontSize:11,color:T.sec}}>{a.s}</div></div>
                  {ob.activity===a.v&&<span style={{color:T.lime,fontWeight:900}}>‚úì</span>}
                </div>
              ))}
            </div>
            <div>
              <div style={{fontSize:11,fontWeight:800,color:T.sec,marginBottom:10,textTransform:'uppercase',letterSpacing:'.5px'}}>Diet Preference</div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                {[{v:'highprotein',e:'ü•©',t:'High Protein'},{v:'balanced',e:'‚öñÔ∏è',t:'Balanced'},{v:'lowcarb',e:'ü•ë',t:'Low Carb'},{v:'vegetarian',e:'ü•ó',t:'Vegetarian'}].map(d=>(
                  <div key={d.v} onClick={()=>upd('diet',d.v)} style={{padding:'14px 10px',borderRadius:14,border:`1.5px solid ${ob.diet===d.v?T.lime:T.bdr}`,background:ob.diet===d.v?T.limeDim:T.surf,cursor:'pointer',textAlign:'center',transition:'all .15s'}}>
                    <div style={{fontSize:24,marginBottom:6}}>{d.e}</div>
                    <div style={{fontSize:12,fontWeight:700,color:ob.diet===d.v?T.lime:T.sec}}>{d.t}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>}

          {step===4&&<div style={{display:'flex',flexDirection:'column',gap:9}}>
            {[{i:'üî•',l:'Daily Calories',v:`${obTarget} kcal`,c:T.lime},{i:'ü•©',l:'Protein',v:`${obMacros.protein}g/day`,c:T.teal},{i:'üåæ',l:'Carbohydrates',v:`${obMacros.carbs}g/day`,c:T.orange},{i:'ü•ë',l:'Fat',v:`${obMacros.fat}g/day`,c:T.pink},{i:'‚ö°',l:'Goal',v:{lose:'Lose Weight',gain:'Gain Muscle',maintain:'Maintain'}[ob.goal],c:T.violet}].map(r=>(
              <div key={r.l} style={{display:'flex',alignItems:'center',gap:12,padding:'13px 16px',background:T.surf,border:`1px solid ${T.bdr}`,borderRadius:16}}>
                <span style={{fontSize:20}}>{r.i}</span>
                <div style={{flex:1,fontSize:13,color:T.sec}}>{r.l}</div>
                <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:14,color:r.c}}>{r.v}</div>
              </div>
            ))}
          </div>}

          <div style={{marginTop:26,display:'flex',gap:10}}>
            {step>1&&<button className="btn-ghost" style={{flex:1}} onClick={()=>setStep(s=>s-1)}>‚Üê Back</button>}
            <button className="btn-pri" style={{flex:2}} onClick={()=>step<4?setStep(s=>s+1):handleDone()}>
              {step===4?'Start Tracking üöÄ':step===3?'See My Plan ‚Üí':'Next ‚Üí'}
            </button>
          </div>
        </div>
      </div>
    </>
  );

  return (
    <>
      <style>{makeCSS(T)}</style>
      <div className="shell">
        <div className="scroll">
          <div style={{padding:'64px 24px 0',textAlign:'center',position:'relative',overflow:'hidden'}}>
            <div style={{position:'absolute',top:-60,left:'50%',transform:'translateX(-50%)',width:340,height:340,background:`radial-gradient(circle,${T.limeG},transparent 70%)`,pointerEvents:'none'}}/>
            <div style={{position:'absolute',bottom:-40,right:-40,width:200,height:200,background:`radial-gradient(circle,${T.tealDim},transparent 70%)`,pointerEvents:'none'}}/>
            <div style={{width:84,height:84,borderRadius:26,background:`linear-gradient(135deg,${T.lime},${T.teal})`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:38,margin:'0 auto 22px',boxShadow:`0 8px 32px ${T.limeG}`,animation:'breathe 3s ease-in-out infinite'}}>ü•¶</div>
            <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:34,letterSpacing:'-1.4px',marginBottom:8,lineHeight:1,color:T.text}}>nutri<span style={{color:T.lime}}>AI</span></div>
            <div style={{fontSize:14,color:T.sec,marginBottom:34,lineHeight:1.65}}>AI-powered nutrition tracking.<br/>Know what you eat. Hit your goals.</div>
            <div style={{display:'flex',background:T.surf2,borderRadius:14,padding:4,gap:3,marginBottom:32,border:`1px solid ${T.bdr}`}}>
              {[{id:'login',l:'Sign In'},{id:'register',l:'Create Account'}].map(t=>(
                <div key={t.id} onClick={()=>{setTab(t.id);setErr('');}} style={{flex:1,padding:'10px',borderRadius:10,background:tab===t.id?T.surf:'transparent',fontFamily:'var(--fh)',fontWeight:700,fontSize:13,cursor:'pointer',color:tab===t.id?T.text:T.sec,transition:'all .2s',boxShadow:tab===t.id?'0 1px 8px rgba(0,0,0,.25)':'none'}}>{t.l}</div>
              ))}
            </div>
          </div>
          <div style={{padding:'0 24px 50px'}}>
            <div style={{display:'flex',flexDirection:'column',gap:12}}>
              {tab==='register'&&<div><div style={{fontSize:10,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',color:T.sec,marginBottom:6}}>Full Name</div><input style={inp} placeholder="Your name" value={name} onChange={e=>setName(e.target.value)}/></div>}
              <div><div style={{fontSize:10,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',color:T.sec,marginBottom:6}}>Email Address</div><input style={inp} type="email" placeholder="you@email.com" value={email} onChange={e=>setEmail(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAuth()}/></div>
              <div>
                <div style={{fontSize:10,fontWeight:800,letterSpacing:'.7px',textTransform:'uppercase',color:T.sec,marginBottom:6}}>Password</div>
                <div style={{position:'relative'}}>
                  <input style={{...inp,paddingRight:50}} type={showPw?'text':'password'} placeholder={tab==='login'?'Your password':'Min. 8 characters'} value={pw} onChange={e=>setPw(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAuth()}/>
                  <div onClick={()=>setShowPw(v=>!v)} style={{position:'absolute',right:14,top:'50%',transform:'translateY(-50%)',cursor:'pointer',fontSize:18,userSelect:'none',color:T.sec}}>{showPw?'üôà':'üëÅ'}</div>
                </div>
              </div>
              {err&&<div style={{background:T.redDim,border:`1px solid ${T.red}28`,borderRadius:12,padding:'11px 14px',fontSize:13,color:T.red,fontWeight:600}}>‚ö† {err}</div>}
              <button className="btn-pri" style={{marginTop:4}} onClick={handleAuth} disabled={loading}>
                {loading?<><div style={{width:16,height:16,borderRadius:'50%',border:'2px solid rgba(7,7,12,.2)',borderTopColor:'#07070c',animation:'spin .7s linear infinite'}}/> {tab==='login'?'Signing in‚Ä¶':'Creating account‚Ä¶'}</>:tab==='login'?'Sign In ‚Üí':'Create Account ‚Üí'}
              </button>
              {tab==='login'&&<div style={{textAlign:'center',fontSize:12,color:T.sec,cursor:'pointer',padding:'2px'}}>Forgot your password?</div>}
              <div onClick={()=>onLogin({...INIT_USER,plan:'pro'})} style={{marginTop:6,padding:'14px 18px',background:T.limeDim,border:`1px solid ${T.lime}22`,borderRadius:18,textAlign:'center',cursor:'pointer',transition:'all .2s'}}>
                <div style={{fontSize:11,fontWeight:800,color:T.lime,textTransform:'uppercase',letterSpacing:'.6px',marginBottom:3}}>‚ö° Demo Mode</div>
                <div style={{fontSize:12,color:T.sec}}>Skip login ‚Äî explore with sample Pro data</div>
              </div>
              <div style={{marginTop:16,paddingTop:16,borderTop:`1px solid ${T.bdr}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <select className="lang-sel" value={lang} onChange={e=>setLang(e.target.value)}><option value="en">üá∫üá∏ English</option><option value="es">üá™üá∏ Espa√±ol</option></select>
                <div className="ib" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß13  LOGOUT CONFIRMATION MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LogoutModal = memo(({ onClose, onLogout, onLogoutAll, T }) => {
  const [phase, setPhase] = useState('confirm');

  const doLogout = async (all=false) => {
    setPhase('loading');
    await new Promise(r=>setTimeout(r,1200));
    setPhase('done');
    await new Promise(r=>setTimeout(r,700));
    all ? onLogoutAll() : onLogout();
  };

  return (
    <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.85)',backdropFilter:'blur(18px)',zIndex:600,display:'flex',alignItems:'flex-end',justifyContent:'center',animation:'fadeIn .22s ease'}}>
      <div style={{width:'100%',maxWidth:430,background:T.surf,borderRadius:'28px 28px 0 0',border:`1px solid ${T.bdr}`,borderBottom:'none',padding:'0 22px 48px',animation:'slideUp .32s cubic-bezier(.34,1.56,.64,1)'}}>
        <div style={{width:38,height:4,background:T.bdr2,borderRadius:2,margin:'12px auto 26px'}}/>

        {phase==='loading'&&(
          <div style={{textAlign:'center',padding:'24px 0 20px'}}>
            <div style={{width:52,height:52,borderRadius:'50%',border:`3px solid ${T.redDim}`,borderTopColor:T.red,animation:'spin .85s linear infinite',margin:'0 auto 20px'}}/>
            <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:19,marginBottom:8,color:T.text}}>Logging out‚Ä¶</div>
            <div style={{fontSize:13,color:T.sec,lineHeight:1.6}}>Revoking session tokens securely.<br/>Clearing local storage.</div>
          </div>
        )}

        {phase==='done'&&(
          <div style={{textAlign:'center',padding:'24px 0 20px'}}>
            <div style={{width:64,height:64,borderRadius:'50%',background:T.greenDim,border:`1px solid ${T.green}22`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:30,margin:'0 auto 16px'}}>‚úì</div>
            <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:19,color:T.green,marginBottom:6}}>Logged out safely</div>
            <div style={{fontSize:13,color:T.sec}}>Your session has been revoked.</div>
          </div>
        )}

        {phase==='confirm'&&(<>
          <div style={{width:72,height:72,borderRadius:22,background:T.redDim,border:`1px solid ${T.red}22`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:32,margin:'0 auto 20px'}}>üö™</div>
          <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:23,letterSpacing:'-.6px',textAlign:'center',marginBottom:10,color:T.text}}>Log Out?</div>
          <div style={{fontSize:13,color:T.sec,textAlign:'center',lineHeight:1.7,marginBottom:24,padding:'0 12px'}}>Your data stays safe. You can log back in anytime.</div>
          <div style={{height:1,background:T.bdr,marginBottom:16}}/>
          <div onClick={()=>doLogout(false)} style={{display:'flex',alignItems:'center',gap:13,padding:'15px 16px',borderRadius:16,background:T.redDim,border:`1px solid ${T.red}22`,cursor:'pointer',marginBottom:10,transition:'all .2s'}}>
            <span style={{fontSize:22}}>üö™</span>
            <div style={{flex:1}}><div style={{fontWeight:800,fontSize:14,color:T.red,marginBottom:2}}>Log Out of This Device</div><div style={{fontSize:11,color:T.sec}}>Revokes this session only</div></div>
          </div>
          <div onClick={()=>doLogout(true)} style={{display:'flex',alignItems:'center',gap:13,padding:'15px 16px',borderRadius:16,background:T.orangeDim,border:`1px solid ${T.orange}22`,cursor:'pointer',marginBottom:16,transition:'all .2s'}}>
            <span style={{fontSize:22}}>üì±</span>
            <div style={{flex:1}}><div style={{fontWeight:800,fontSize:14,color:T.orange,marginBottom:2}}>Log Out of All Devices</div><div style={{fontSize:11,color:T.sec}}>Revokes every active session</div></div>
          </div>
          <button className="btn-ghost" onClick={onClose}>Cancel</button>
        </>)}
      </div>
    </div>
  );
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ¬ß11  ROOT APP ‚Äî GLOBAL STATE + NAVIGATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
export default function NutriAI() {
  /* ‚îÄ‚îÄ Theme & locale ‚îÄ‚îÄ */
  const [theme, setTheme] = useState('dark');
  const [lang,  setLang]  = useState('en');
  const T   = theme === 'dark' ? DARK : LIGHT;
  const txt = I18N[lang] || I18N.en;

  /* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
  const [isLoggedIn,    setIsLoggedIn]    = useState(false);
  const [logoutVisible, setLogoutVisible] = useState(false);
  const [authUser,      setAuthUser]      = useState(null);

  /* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
  const [screen, setScreen] = useState('home'); // home | ideas | profile | stats
  const [statsTab, setStTab] = useState('weight');
  const [chartPeriod, setChartPeriod] = useState('week');
  const [showEmptyDemo, setShowEmptyDemo] = useState(false);

  /* ‚îÄ‚îÄ User & daily data (global, shared across all screens) ‚îÄ‚îÄ */
  const [user, setUser]   = useState({ ...INIT_USER });
  const [daily, setDaily] = useState({ ...ZERO_DAILY }); // today's food log
  const [weightLogs]      = useState(() => genWeightLogs(INIT_USER.weightKg + 3.1));
  const [dailyLogs, setDailyLogs] = useState(() => genDailyLogs(INIT_USER.calorie_target));
  const [isFirstTime, setIsFirstTime] = useState(true); // true until first meal logged

  /* ‚îÄ‚îÄ UI state ‚îÄ‚îÄ */
  const [scanOpen, setScanOpen] = useState(false);
  const [editOpen, setEditOpen] = useState(false);
  const [toast, setToast]       = useState(null);
  const [newWeight, setNewWeight] = useState('');
  const [activeDay, setActiveDay] = useState(6);

  /* ‚îÄ‚îÄ Ideas state ‚îÄ‚îÄ */
  const [ideasPhase, setIdeasPhase] = useState('idle'); // idle|loading|results|limit
  const [ideas, setIdeas]           = useState([]);
  const [loadStep, setLoadStep]     = useState(0);
  const [ideasUsed, setIdeasUsed]   = useState(0);
  const IDEA_LIMIT = user.plan === 'pro' ? Infinity : 1;

  /* ‚îÄ‚îÄ AI stats report ‚îÄ‚îÄ */
  const [aiReport, setAiReport] = useState(null);
  const [aiReportLoad, setAiReportLoad] = useState(false);

  /* ‚îÄ‚îÄ Toast helper ‚îÄ‚îÄ */
  const showToast = useCallback((msg) => {
    setToast(msg); setTimeout(() => setToast(null), 2600);
  }, []);

  /* ‚îÄ‚îÄ Computed from daily (zero-safe) ‚îÄ‚îÄ */
  const consumed = daily.consumed || 0;
  const remaining = useMemo(() => ({
    calories: Math.max(0, user.calorie_target - consumed),
    protein:  Math.max(0, user.protein_target - (daily.protein || 0)),
    carbs:    Math.max(0, user.carb_target    - (daily.carbs   || 0)),
    fat:      Math.max(0, user.fat_target     - (daily.fat     || 0)),
  }), [daily, user]);

  /* ‚îÄ‚îÄ Stats computed from historical data ‚îÄ‚îÄ */
  const stats = useMemo(() => {
    if (showEmptyDemo || !dailyLogs.length)
      return { weeklyAvg:0, daysOnTarget:0, weekCompletion:0, proteinAdh:0, carbAdh:0, fatAdh:0, adherenceScore:0 };
    const l7  = dailyLogs.slice(-7);
    const l14 = dailyLogs.slice(-14);
    const weeklyAvg    = Math.round(l7.reduce((s,l)=>s+l.calories,0) / l7.length);
    const daysOnTarget = l7.filter(l=>{const r=l.calories/user.calorie_target;return r>=.85&&r<=1.15;}).length;
    const weekCompletion = Math.round(daysOnTarget/7*100);
    const proteinAdh = Math.round(l14.reduce((s,l)=>s+clamp(l.protein/user.protein_target,0,1),0)/14*100);
    const carbAdh    = Math.round(l14.reduce((s,l)=>s+clamp(l.carbs/user.carb_target,0,1),0)/14*100);
    const fatAdh     = Math.round(l14.reduce((s,l)=>s+clamp(l.fat/user.fat_target,0,1),0)/14*100);
    const adherenceScore = Math.round(proteinAdh*.45 + carbAdh*.3 + fatAdh*.25);
    return { weeklyAvg, daysOnTarget, weekCompletion, proteinAdh, carbAdh, fatAdh, adherenceScore };
  }, [dailyLogs, user, showEmptyDemo]);

  const wProg = useMemo(() => {
    if (showEmptyDemo || weightLogs.length < 2) return { delta:0, deltaStr:'‚Äî', toGoal:0, pct:0, current:user.weightKg };
    const first=weightLogs[0].weight, last=weightLogs[weightLogs.length-1].weight;
    const delta = +(last-first).toFixed(1);
    const toGoal = +(last-user.targetWeightKg).toFixed(1);
    const total  = Math.abs(first-user.targetWeightKg);
    return { delta, deltaStr:`${delta>0?'+':''}${delta}kg`, toGoal, pct:clamp(total?Math.round(Math.abs(first-last)/total*100):0,0,100), current:last };
  }, [weightLogs, user, showEmptyDemo]);

  const chartData = useMemo(() => {
    if (showEmptyDemo) return [];
    const all = weightLogs.map(l=>({date:l.date,value:l.weight}));
    return chartPeriod==='week'?all.slice(-7):chartPeriod==='month'?all.slice(-30):all;
  }, [weightLogs, chartPeriod, showEmptyDemo]);

  const calChartData = useMemo(() => showEmptyDemo?[]:dailyLogs.slice(-7).map(l=>({date:l.date,value:l.calories})), [dailyLogs,showEmptyDemo]);

  /* ‚îÄ‚îÄ Date strip ‚îÄ‚îÄ */
  const days = useMemo(() => {
    const now = new Date();
    return Array.from({ length:7 }, (_,i) => {
      const d = new Date(now); d.setDate(now.getDate()-(6-i));
      return { name:d.toLocaleDateString('en',{weekday:'short'}).slice(0,3).toUpperCase(), num:d.getDate() };
    });
  }, []);

  /* ‚îÄ‚îÄ AI report trigger ‚îÄ‚îÄ */
  useEffect(() => {
    if (statsTab==='ai' && !aiReport && !aiReportLoad && user.plan==='pro' && !showEmptyDemo) {
      setAiReportLoad(true);
      getAISummary(user, weightLogs, dailyLogs).then(d=>{ setAiReport(d); setAiReportLoad(false); });
    }
  }, [statsTab]);

  /* ‚îÄ‚îÄ Handlers ‚îÄ‚îÄ */

  // Add scanned meal to today's daily log
  const handleAddMeal = useCallback((meal, type) => {
    setDaily(prev => {
      const updatedMeals = prev.meals.map(m =>
        m.type === type && !m.logged
          ? { ...m, logged:true, name:meal.name, emoji:meal.emoji, calories:meal.calories, protein:meal.protein, carbs:meal.carbs, fat:meal.fat, time:new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}) }
          : m
      );
      const newConsumed = updatedMeals.reduce((s,m) => s + (m.calories||0), 0);
      return { ...prev, consumed:newConsumed, protein:updatedMeals.reduce((s,m)=>s+(m.protein||0),0), carbs:updatedMeals.reduce((s,m)=>s+(m.carbs||0),0), fat:updatedMeals.reduce((s,m)=>s+(m.fat||0),0), meals:updatedMeals };
    });
    setIsFirstTime(false);
    showToast(`‚úì ${meal.name} added to ${MEAL_LABELS[type]}`);
  }, [showToast]);

  // Save profile and recalculate
  const handleSaveProfile = useCallback(updated => {
    setUser(p => ({ ...p, ...updated }));
    showToast('‚úì Profile & targets updated');
  }, [showToast]);

  // Log weight + recalculate targets
  const handleLogWeight = () => {
    const w = parseFloat(newWeight);
    if (!w||w<30||w>300) { showToast('‚ö† Enter a valid weight (30‚Äì300kg)'); return; }
    const bmr = calcBMR(user.age, user.gender, w, user.heightCm);
    const tdee = calcTDEE(bmr, user.activity);
    const target = calcTarget(tdee, user.goal_type);
    const macros = calcMacros(target, user.diet);
    setUser(p => ({ ...p, weightKg:w, calorie_target:target, protein_target:macros.protein, carb_target:macros.carbs, fat_target:macros.fat }));
    setNewWeight('');
    showToast(`‚úì ${w}kg logged ¬∑ targets recalculated`);
  };

  // Generate meal ideas
  const handleGenerate = useCallback(async () => {
    if (ideasUsed >= IDEA_LIMIT) { setIdeasPhase('limit'); return; }
    setIdeasPhase('loading'); setLoadStep(0); setIdeas([]);
    [0, 750, 1450, 2100].forEach((t,i) => setTimeout(()=>setLoadStep(i+1), t));
    const results = await generateMealIdeas(remaining, user.goal_type, user.diet, user.plan);
    setIdeas(Array.isArray(results) ? results.slice(0,3) : results);
    setIdeasUsed(v=>v+1);
    setIdeasPhase('results');
  }, [remaining, user, ideasUsed, IDEA_LIMIT]);

  const handleRegen = useCallback(() => {
    if (ideasUsed >= IDEA_LIMIT) { setIdeasPhase('limit'); return; }
    setIdeasPhase('idle');
    setTimeout(()=>handleGenerate(), 50);
  }, [ideasUsed, IDEA_LIMIT, handleGenerate]);

  // Auth handlers
  const handleLogin = useCallback((userData) => {
    setUser(p => ({ ...p, ...userData }));
    setAuthUser(userData);
    setIsLoggedIn(true);
    showToast(`‚úì Welcome back, ${(userData.name||'friend').split(' ')[0]}!`);
  }, [showToast]);

  const handleLogout = useCallback(() => {
    setIsLoggedIn(false);
    setAuthUser(null);
    setUser({ ...INIT_USER });
    setDaily({ ...ZERO_DAILY });
    setScreen('home');
    setLogoutVisible(false);
    showToast('üëã You\'ve been logged out');
  }, [showToast]);

  // Quick nav helper
  const goTo = useCallback(s => setScreen(s), []);

  /* ‚îÄ‚îÄ Which meal types still unlocked ‚îÄ‚îÄ */
  const unloggedTypes = daily.meals.filter(m=>!m.logged).map(m=>m.type);
  const showNudge = remaining.protein > 30 && !isFirstTime;
  const insightOfDay = AI_INSIGHTS_POOL[Math.floor(Date.now() / 86400000) % AI_INSIGHTS_POOL.length];

  const GOAL_LBL  = { lose:'Cutting', gain:'Bulking', maintain:'Maintenance' };
  const ACT_LBL   = { sedentary:'Sedentary', light:'Light', moderate:'Moderate', active:'Very Active' };
  const DIET_LBL  = { highprotein:'High Protein', balanced:'Balanced', lowcarb:'Low Carb', vegetarian:'Vegetarian' };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     RENDER
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  // Gate: show Login/Onboarding if not authenticated
  if (!isLoggedIn) {
    return (
      <>
        <style key={theme}>{makeCSS(T)}</style>
        <LoginScreen onLogin={handleLogin} T={T} theme={theme} setTheme={setTheme} lang={lang} setLang={setLang}/>
      </>
    );
  }

  return (
    <>
      <style key={theme}>{makeCSS(T)}</style>
      {toast && <div className="toast">{toast}</div>}
      {logoutVisible && <LogoutModal T={T} onClose={()=>setLogoutVisible(false)} onLogout={handleLogout} onLogoutAll={handleLogout}/>}
      {scanOpen && <ScanModal onAdd={handleAddMeal} onClose={()=>setScanOpen(false)} mealTypes={unloggedTypes}/>}
      {editOpen && <EditModal user={user} onSave={handleSaveProfile} onClose={()=>setEditOpen(false)} T={T}/>}

      <div className="shell">
        <div className="scroll">

          {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              ‚¨°  HOME / DASHBOARD
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          {screen === 'home' && (
            <>
              {/* Topbar */}
              <div style={{padding:'50px 20px 0',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}} className="a1">
                <div>
                  <div style={{fontSize:12,color:T.sec,fontWeight:500,marginBottom:2}}>{getGreeting()},</div>
                  <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:24,letterSpacing:'-.7px'}}>
                    {user.name.split(' ')[0]} {isFirstTime?'üå±':'üëã'}
                  </div>
                </div>
                <div style={{display:'flex',gap:8,alignItems:'center'}}>
                  <select className="lang-sel" value={lang} onChange={e=>setLang(e.target.value)}>
                    <option value="en">üá∫üá∏ EN</option><option value="es">üá™üá∏ ES</option>
                  </select>
                  <div className="ib" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</div>
                  <div onClick={()=>goTo('profile')} style={{width:36,height:36,borderRadius:'50%',background:`linear-gradient(135deg,${T.lime},${T.teal})`,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'var(--fh)',fontWeight:900,fontSize:13,color:'#07070c',boxShadow:`0 2px 12px ${T.limeG}`,cursor:'pointer'}}>
                    {user.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase()}
                  </div>
                </div>
              </div>

              {/* Goal + streak strip */}
              <div style={{padding:'12px 20px 0',display:'flex',gap:8}} className="a2">
                <div style={{display:'flex',alignItems:'center',gap:6,background:T.surf,border:`1px solid ${T.bdr}`,borderRadius:10,padding:'7px 12px',fontSize:11,fontWeight:700,color:T.sec}}>
                  üéØ <span>{GOAL_LBL[user.goal_type]}</span>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:6,background:T.surf,border:`1px solid ${T.bdr}`,borderRadius:10,padding:'7px 12px',fontSize:11,fontWeight:700,color:T.sec}}>
                  üî• <span style={{color:T.orange}}>{user.streak}</span> day streak
                </div>
                <div style={{flex:1}}/>
                <div onClick={()=>goTo('ideas')} style={{display:'flex',alignItems:'center',gap:5,background:T.limeDim,border:`1px solid ${T.lime}28`,borderRadius:10,padding:'7px 12px',fontSize:11,fontWeight:800,color:T.lime,cursor:'pointer'}}>
                  ‚ú¶ Ideas
                </div>
              </div>

              {/* Date strip */}
              <div className="date-strip a2">
                {days.map((d,i)=>(
                  <div key={i} onClick={()=>setActiveDay(i)} className="date-chip"
                    style={{background:activeDay===i?T.lime:T.surf,border:`1px solid ${activeDay===i?'transparent':T.bdr}`}}>
                    <div style={{fontSize:9,fontWeight:700,letterSpacing:'.6px',textTransform:'uppercase',color:activeDay===i?'#07070c80':T.muted,marginBottom:4}}>{d.name}</div>
                    <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:17,color:activeDay===i?'#07070c':T.text}}>{d.num}</div>
                    <div style={{width:4,height:4,borderRadius:'50%',background:activeDay===i?'#07070c60':i<6&&i!==activeDay?T.lime:'transparent',marginTop:5}}/>
                  </div>
                ))}
              </div>

              {/* ‚îÄ‚îÄ FIRST-TIME EMPTY STATE ‚îÄ‚îÄ */}
              {isFirstTime && (
                <div className="sec a3">
                  <div className="empty-hero">
                    <div className="eh-bg1"/><div className="eh-bg2"/>
                    <div className="eh-orb">
                      <div className="eh-ring"><div className="eh-inner">üì∏</div></div>
                    </div>
                    <div className="eh-title">{txt.journeyStart}<br/><em>Start today.</em></div>
                    <div className="eh-sub">Scan your first meal to begin tracking. Our AI calculates calories and macros instantly.</div>
                    <button className="eh-cta" onClick={()=>setScanOpen(true)}>
                      <span style={{fontSize:20}}>üì∏</span> {txt.scanFirst}
                    </button>
                    <div className="eh-zero-row">
                      {[{l:'Calories',c:T.lime},{l:'Protein',c:T.teal},{l:'Carbs',c:T.orange},{l:'Fat',c:T.pink}].map(m=>(
                        <div key={m.l} className="eh-zc">
                          <div className="eh-zring" style={{borderColor:m.c+'40',color:m.c}}>0</div>
                          <div className="eh-zlbl">{m.l}</div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Empty meal slots */}
                  <div style={{marginTop:18}}>
                    {[
                      {type:'breakfast',icon:'üåÖ',sub:'Start strong with a balanced breakfast'},
                      {type:'lunch',    icon:'‚òÄÔ∏è',sub:'Fuel your afternoon with smart macros'},
                      {type:'dinner',   icon:'üåô',sub:'End the day with a recovery meal'},
                      {type:'snacks',   icon:'‚ö°',sub:'Hit your protein gap with a quick bite'},
                    ].map((s,i)=>(
                      <div key={s.type} className="empty-slot" style={{animationDelay:`${.07*i}s`}} onClick={()=>setScanOpen(true)}>
                        <div className="es-icon">{s.icon}</div>
                        <div className="es-info">
                          <div className="es-name">{MEAL_LABELS[s.type]}</div>
                          <div className="es-sub">{s.sub}</div>
                        </div>
                        <div className="es-add">+</div>
                      </div>
                    ))}
                  </div>

                  {/* Ideas nudge */}
                  <div style={{marginTop:14}}>
                    <div className="nudge" style={{background:`linear-gradient(135deg,${T.violetDim},${T.tealDim})`,borderColor:`${T.violet}22`}} onClick={()=>goTo('ideas')}>
                      <div className="nudge-ico">‚ú¶</div>
                      <div className="nudge-txt">
                        <div className="nudge-ttl" style={{color:T.violet}}>Not sure what to eat?</div>
                        <div className="nudge-sub">AI Meal Ideas tailored to your goals</div>
                      </div>
                      <div className="nudge-cta">Try ‚Üí</div>
                    </div>
                  </div>
                </div>
              )}

              {/* ‚îÄ‚îÄ POPULATED DASHBOARD ‚îÄ‚îÄ */}
              {!isFirstTime && (
                <>
                  {/* Calorie ring card */}
                  <div className="sec a3">
                    <div className="ring-card">
                      <div className="ring-orb"/><div className="ring-orb2"/>
                      <div className="ring-layout">
                        <div style={{position:'relative',flexShrink:0}}>
                          <CalRing consumed={consumed} goal={user.calorie_target} size={134}/>
                          <div className="ring-center">
                            <div className={`ring-num ${consumed>user.calorie_target?'':''}` } style={{color:consumed>user.calorie_target?T.red:T.text}}>{consumed}</div>
                            <div className="ring-unit">consumed</div>
                            <div className="ring-pct" style={{color:consumed>user.calorie_target?T.red:T.lime}}>{Math.round(consumed/user.calorie_target*100)}%</div>
                          </div>
                        </div>
                        <div className="ring-stats">
                          {[
                            {l:'Protein',v:daily.protein,t:user.protein_target,c:T.teal,   d:0},
                            {l:'Carbs',  v:daily.carbs,  t:user.carb_target,   c:T.orange, d:120},
                            {l:'Fat',    v:daily.fat,    t:user.fat_target,    c:T.pink,   d:240},
                          ].map(m=>(
                            <div key={m.l} className="rs-row">
                              <div className="rs-top">
                                <div className="rs-lbl"><div className="rs-dot" style={{background:m.c}}/>{m.l}</div>
                                <div className="rs-val" style={{color:m.c}}>{m.v||0}g <span style={{color:T.muted,fontSize:10,fontWeight:400}}>/ {m.t}g</span></div>
                              </div>
                              <ABar pct={(m.v||0)/m.t*100} color={m.c} delay={m.d}/>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="ring-footer">
                        {[
                          {l:'Goal',v:user.calorie_target,c:T.sec},
                          {l:'Remaining',v:remaining.calories,c:remaining.calories<150?T.red:T.lime},
                          {l:'Burned',v:daily.burned||0,c:T.pink},
                          {l:'Net',v:consumed-(daily.burned||0),c:T.sec},
                        ].map(s=>(
                          <div key={s.l} className="rfc">
                            <div className="rfc-val" style={{color:s.c}}>{s.v.toLocaleString()}</div>
                            <div className="rfc-lbl">{s.l}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Protein nudge */}
                  {showNudge && (
                    <div className="sec a4">
                      <div className="nudge" onClick={()=>goTo('ideas')}>
                        <div className="nudge-ico">üí™</div>
                        <div className="nudge-txt">
                          <div className="nudge-ttl">Need more protein today?</div>
                          <div className="nudge-sub">You're {remaining.protein}g below target ‚Äî tap for a smart meal idea.</div>
                        </div>
                        <div className="nudge-cta">Generate ‚Üí</div>
                      </div>
                    </div>
                  )}

                  {/* AI Insight card */}
                  <div className="sec a4">
                    <div className="ai-insight-card">
                      <div className="aic-orb1"/><div className="aic-orb2"/>
                      <div className="aic-hdr">
                        <div className="aic-orb">‚ú¶</div>
                        <div className="aic-ttl">AI Insight</div>
                      </div>
                      <div className="aic-item">
                        <div className="aic-item-ico" style={{background:{success:T.limeDim,info:T.tealDim,warning:T.orangeDim}[insightOfDay.type]||T.limeDim}}>
                          {insightOfDay.icon}
                        </div>
                        <div className="aic-item-txt" dangerouslySetInnerHTML={{__html:insightOfDay.msg}}/>
                      </div>
                    </div>
                  </div>

                  {/* Today's meals */}
                  <div className="sec a5">
                    <div className="sechd">
                      <div className="sectitle">Today's Meals</div>
                      <div className="secact" onClick={()=>setScanOpen(true)}>+ Scan</div>
                    </div>
                    {daily.meals.map((m,i) => m.logged ? (
                      <div key={m.id} className="meal-card" style={{animationDelay:`${.05*i}s`}}>
                        <div className="mc-top">
                          <div className="mc-icon">{m.emoji}</div>
                          <div className="mc-info">
                            <div className="mc-name">{m.name}</div>
                            <div className="mc-time">{MEAL_LABELS[m.type]} ¬∑ {m.time}</div>
                          </div>
                          <div className="mc-right">
                            <div className="mc-cal">{m.calories}</div>
                            <div className="mc-unit">kcal</div>
                          </div>
                        </div>
                        <div className="mc-macros">
                          {[{l:'P',v:m.protein,c:T.teal},{l:'C',v:m.carbs,c:T.orange},{l:'F',v:m.fat,c:T.pink}].map(mc=>(
                            <div key={mc.l} className="mc-macro">
                              <div className="mc-mv" style={{color:mc.c}}>{mc.v}g</div>
                              <div className="mc-ml">{mc.l}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ) : (
                      <div key={m.id} className="empty-slot" style={{animationDelay:`${.05*i}s`}} onClick={()=>setScanOpen(true)}>
                        <div className="es-icon">{m.emoji}</div>
                        <div className="es-info">
                          <div className="es-name">{MEAL_LABELS[m.type]}</div>
                          <div className="es-sub">Tap to log</div>
                        </div>
                        <div className="es-add">+</div>
                      </div>
                    ))}
                  </div>

                  {/* Stats quick-link */}
                  <div className="sec a6" style={{paddingBottom:4}}>
                    <div style={{background:T.surf,border:`1px solid ${T.bdr}`,borderRadius:22,padding:'14px 18px',display:'flex',alignItems:'center',gap:14,cursor:'pointer'}} onClick={()=>goTo('stats')}>
                      <div style={{fontSize:28}}>üìä</div>
                      <div style={{flex:1}}>
                        <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:14,marginBottom:3}}>View Progress & Stats</div>
                        <div style={{fontSize:11,color:T.sec}}>Weight trend, macro adherence, streak calendar</div>
                      </div>
                      <div style={{fontSize:16,color:T.muted}}>‚Ä∫</div>
                    </div>
                  </div>
                </>
              )}
            </>
          )}

          {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              ‚ú¶  MEAL IDEAS GENERATOR
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          {screen === 'ideas' && (
            <>
              {/* Header */}
              <div style={{padding:'50px 20px 0',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}} className="a1">
                <div>
                  <div style={{fontSize:12,color:T.sec,fontWeight:500,marginBottom:2}}>nutriAI</div>
                  <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:24,letterSpacing:'-.7px'}}>{txt.mealIdeas}</div>
                </div>
                <div style={{display:'flex',gap:8}}>
                  <div className="ib" onClick={()=>goTo('home')}>‚Üê</div>
                  <div className="ib" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</div>
                </div>
              </div>

              {/* Trigger card */}
              {(ideasPhase==='idle'||ideasPhase==='limit') && (
                <div className="sec a2">
                  <div className="ideas-trigger">
                    <div className="it-orb1"/><div className="it-orb2"/>
                    <div className="it-badge"><div className="it-dot"/> AI-Powered ¬∑ Personalized</div>
                    <div className="it-title">Smart <em>Meal Ideas</em><br/>built for your goals</div>
                    <div className="it-sub">AI analyzes your remaining macros and goal to generate 3 meals that fit perfectly into your day.</div>

                    {/* Remaining macros pills */}
                    <div className="mrp-row">
                      {[
                        {l:`${remaining.calories} kcal left`, c:T.lime},
                        {l:`${remaining.protein}g protein`, c:T.teal},
                        {l:`${remaining.carbs}g carbs`, c:T.orange},
                        {l:`${remaining.fat}g fat`, c:T.pink},
                      ].map(m=>(
                        <div key={m.l} className="mrp">
                          <div className="mrp-dot" style={{background:m.c}}/>
                          <span style={{color:m.c,fontFamily:'var(--fh)',fontWeight:800}}>{m.l}</span>
                        </div>
                      ))}
                    </div>

                    {/* Free plan notice */}
                    {user.plan === 'free' && (
                      <div style={{marginBottom:14,fontSize:12,color:T.sec,display:'flex',alignItems:'center',gap:8}}>
                        <span style={{background:T.orangeDim,border:`1px solid ${T.orange}22`,borderRadius:6,padding:'3px 8px',fontSize:10,fontWeight:800,color:T.orange}}>FREE</span>
                        {ideasUsed}/{IDEA_LIMIT} ideas used today ¬∑ Resets at midnight
                      </div>
                    )}

                    <button className="btn-pri" onClick={handleGenerate} disabled={ideasPhase==='limit'}>
                      ‚ú¶ {txt.generateIdeas}
                    </button>
                    {user.plan==='free' && (
                      <button className="btn-ghost" style={{marginTop:8}} onClick={()=>showToast('üöÄ Pro upgrade coming soon!')}>
                        üîì Unlimited ideas on Pro
                      </button>
                    )}
                  </div>
                </div>
              )}

              {/* Limit gate */}
              {ideasPhase==='limit' && (
                <div className="sec" style={{marginTop:12}}>
                  <div className="limit-notice">
                    <div className="ln-ico">‚è∞</div>
                    <div className="ln-inf">
                      <div className="ln-ttl">Daily limit reached</div>
                      <div className="ln-sub">You've used your 1 free idea today. Resets at midnight.</div>
                    </div>
                    <div className="ln-badge">{ideasUsed}/{IDEA_LIMIT} used</div>
                  </div>
                  <div className="progate">
                    <div className="pg-ico">‚ö°</div>
                    <div className="pg-inf">
                      <div className="pg-ttl">Upgrade to Pro</div>
                      <div className="pg-sub">Unlimited daily ideas, advanced macro precision, ingredient customization.</div>
                    </div>
                    <button className="pg-btn" onClick={()=>showToast('üöÄ Upgrade!')}>Go Pro</button>
                  </div>
                </div>
              )}

              {/* Loading */}
              {ideasPhase==='loading' && (
                <div className="sec">
                  <div className="ideas-loading">
                    <div className="il-ring"/>
                    <div style={{textAlign:'center'}}>
                      <div style={{fontFamily:'var(--fh)',fontWeight:700,fontSize:16,marginBottom:4}}>{txt.generating}</div>
                      <div style={{fontSize:12,color:T.sec}}>Analyzing your remaining macros</div>
                    </div>
                    <div style={{display:'flex',flexDirection:'column',gap:9}}>
                      {['Analyzing remaining macros','Matching to goal type','Calculating nutritional values','Personalizing meal selection'].map((s,i)=>(
                        <div key={s} className={`il-step ${loadStep>i+1?'done':loadStep===i+1?'active':''}`}>
                          <div className="ils-dot">{loadStep>i+1?'‚úì':i+1}</div>{s}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Results */}
              {ideasPhase==='results' && ideas.length>0 && (
                <div className="sec">
                  {/* Context bar */}
                  <div style={{background:T.surf2,border:`1px solid ${T.bdr}`,borderRadius:14,padding:'11px 15px',marginBottom:14,display:'flex',alignItems:'center',gap:10}}>
                    <div style={{width:26,height:26,borderRadius:8,background:T.limeDim,border:`1px solid ${T.lime}20`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,flexShrink:0}}>‚ú¶</div>
                    <div style={{flex:1}}>
                      <div style={{fontSize:11,fontWeight:800,color:T.lime}}>3 ideas generated</div>
                      <div style={{fontSize:10,color:T.sec}}>Tailored to {remaining.calories} kcal ¬∑ {remaining.protein}g protein remaining</div>
                    </div>
                    {user.plan==='free'&&<div style={{fontSize:10,color:T.orange,fontWeight:800,background:T.orangeDim,border:`1px solid ${T.orange}20`,borderRadius:6,padding:'3px 7px'}}>{ideasUsed}/{IDEA_LIMIT}</div>}
                  </div>

                  {ideas.map((idea,i) => <IdeaCard key={`${idea.name}-${i}`} idea={idea} index={i} onToast={showToast}/>)}

                  <div className="regen-row">
                    <button className="regen-btn" onClick={handleRegen}>‚Ü∫ Regenerate</button>
                    <button className="regen-btn primary" onClick={()=>goTo('home')}>‚Üê Dashboard</button>
                  </div>

                  {/* Pro upsell if free */}
                  {user.plan==='free'&&(
                    <div style={{background:T.surf,border:`1px solid ${T.bdr2}`,borderRadius:18,padding:16,marginTop:14,display:'flex',gap:12,alignItems:'center'}}>
                      <div style={{fontSize:22}}>üîí</div>
                      <div style={{flex:1}}>
                        <div style={{fontSize:13,fontWeight:700,marginBottom:3}}>Want unlimited ideas?</div>
                        <div style={{fontSize:11,color:T.sec}}>Pro users get unlimited daily generation + ingredient customization.</div>
                      </div>
                      <button onClick={()=>showToast('üöÄ Upgrade!')} style={{background:T.violet,color:'#fff',border:'none',borderRadius:10,padding:'9px 13px',fontFamily:'var(--fh)',fontWeight:800,fontSize:12,cursor:'pointer',whiteSpace:'nowrap'}}>Go Pro</button>
                    </div>
                  )}
                </div>
              )}
            </>
          )}

          {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              ‚óâ  PROFILE
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          {screen === 'profile' && (
            <>
              <div style={{padding:'50px 20px 0',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}} className="a1">
                <div>
                  <div style={{fontSize:11,color:T.sec,fontWeight:700,letterSpacing:'.5px',textTransform:'uppercase',marginBottom:4}}>nutriAI</div>
                  <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:24,letterSpacing:'-.7px'}}>Your Profile</div>
                </div>
                <div style={{display:'flex',gap:8}}>
                  <select className="lang-sel" value={lang} onChange={e=>setLang(e.target.value)}>
                    <option value="en">üá∫üá∏ EN</option><option value="es">üá™üá∏ ES</option>
                  </select>
                  <div className="ib" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</div>
                  <div className="ib" onClick={()=>setEditOpen(true)} title="Edit">‚úé</div>
                </div>
              </div>

              <div className="sec a2">
                <div className="phero">
                  <div className="phero-orb1"/><div className="phero-orb2"/>
                  <div className="ph-avrow">
                    <div className="ph-avwrap">
                      <div className="ph-av" onClick={()=>showToast('üì∏ Photo upload ‚Äî coming soon')}>
                        {user.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase()}
                      </div>
                      <div className="ph-av-edit">‚úé</div>
                    </div>
                    <div className="ph-info">
                      <div className="ph-name">{user.name}</div>
                      <div className="ph-meta">{user.age} yrs ¬∑ {user.heightCm}cm ¬∑ {user.weightKg}kg</div>
                      <div className="ph-tags">
                        <span className="pill" style={{background:T.limeDim,color:T.lime,border:`1px solid ${T.lime}28`}}>{GOAL_LBL[user.goal_type]}</span>
                        <span className="pill" style={{background:T.violetDim,color:T.violet,border:`1px solid ${T.violet}28`}}>{user.plan==='pro'?'‚ö° Pro':'Free'}</span>
                      </div>
                    </div>
                  </div>

                  <div className="ph-grid">
                    {[
                      {icon:'‚öñÔ∏è',val:`${user.weightKg}kg`,lbl:'Current Weight',c:T.lime},
                      {icon:'üéØ',val:`${user.targetWeightKg}kg`,lbl:'Target Weight',c:T.teal},
                      {icon:'‚ö°',val:ACT_LBL[user.activity],lbl:'Activity Level',c:T.orange},
                      {icon:'ü•ó',val:DIET_LBL[user.diet],lbl:'Diet',c:T.violet},
                    ].map(m=>(
                      <div key={m.lbl} className="phgc">
                        <div className="phgc-icon">{m.icon}</div>
                        <div className="phgc-val" style={{color:m.c}}>{m.val}</div>
                        <div className="phgc-lbl">{m.lbl}</div>
                      </div>
                    ))}
                  </div>

                  <div style={{fontSize:9,color:T.muted,fontWeight:800,textTransform:'uppercase',letterSpacing:'.6px',marginBottom:10}}>Daily Targets</div>
                  <div className="ph-targets">
                    {[
                      {v:user.calorie_target,u:'kcal',l:'Calories',c:T.lime},
                      {v:`${user.protein_target}g`,u:'',l:'Protein',c:T.teal},
                      {v:`${user.carb_target}g`,u:'',l:'Carbs',c:T.orange},
                      {v:`${user.fat_target}g`,u:'',l:'Fat',c:T.pink},
                    ].map(t=>(
                      <div key={t.l} className="ptc">
                        <div className="ptcv" style={{color:t.c}}>{t.v}</div>
                        {t.u&&<span className="ptcu"> {t.u}</span>}
                        <div className="ptcl">{t.l}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Weight logger */}
              <div className="sec a3">
                <div className="sechd"><div className="sectitle">Log Weight</div></div>
                <div className="card cp">
                  <div style={{fontSize:12,color:T.sec,marginBottom:12}}>
                    Current: <strong style={{color:T.text}}>{user.weightKg}kg</strong>
                    {wProg.delta!==0&&<span style={{marginLeft:8,fontWeight:700,fontSize:12,color:wProg.delta<0?T.green:T.orange}}>{wProg.deltaStr} over 6 weeks</span>}
                  </div>
                  <div className="wlogrow">
                    <input className="wloginput" type="number" step=".1" min="30" max="300"
                      placeholder={`${user.weightKg}`} value={newWeight}
                      onChange={e=>setNewWeight(e.target.value)}
                      onKeyDown={e=>e.key==='Enter'&&handleLogWeight()}/>
                    <button className="wlogbtn" onClick={handleLogWeight}>Log kg ‚Üí</button>
                  </div>
                  <div style={{fontSize:11,color:T.muted}}>Weight updates auto-recalculate BMR, TDEE & daily targets using Mifflin-St Jeor.</div>
                </div>
              </div>

              {/* Settings */}
              <div className="sec a4">
                <div className="sechd"><div className="sectitle">Settings</div></div>
                {[
                  {ico:'üéØ',bg:T.limeDim,   ttl:'Goals & Targets',   sub:`${GOAL_LBL[user.goal_type]} ¬∑ ${user.calorie_target} kcal/day`},
                  {ico:'‚ö°',bg:T.violetDim, ttl:'Upgrade to Pro',    sub:'Unlimited AI insights, predictions & data export'},
                  {ico:'üîî',bg:T.orangeDim, ttl:'Notifications',     sub:'Meal reminders, streak alerts, weekly summaries'},
                  {ico:'üì§',bg:T.pinkDim,   ttl:'Export Data',       sub:user.plan==='pro'?'Export CSV or PDF report':'Pro feature',val:user.plan!=='pro'?'üîí':''},
                  {ico:'üõ°',bg:T.tealDim,   ttl:'Privacy & GDPR',   sub:'Delete data, manage consent'},
                ].map((s,i)=>(
                  <div key={s.ttl} className="sit" style={{animationDelay:`${.05*i}s`}} onClick={()=>showToast(`${s.ttl} ‚Äî coming soon`)}>
                    <div className="si-ico" style={{background:s.bg}}>{s.ico}</div>
                    <div className="si-inf"><div className="si-ttl">{s.ttl}</div><div className="si-sub">{s.sub}</div></div>
                    <div className="si-r">{s.val&&<span>{s.val}</span>}<span>‚Ä∫</span></div>
                  </div>
                ))}

                {/* ‚îÄ‚îÄ LOGOUT BUTTON ‚îÄ‚îÄ */}
                <div style={{marginTop:6}}>
                  <div onClick={()=>setLogoutVisible(true)}
                    style={{display:'flex',alignItems:'center',gap:12,padding:'15px 16px',borderRadius:18,
                      background:T.redDim,border:`1px solid ${T.red}22`,cursor:'pointer',transition:'all .2s'}}>
                    <div style={{width:36,height:36,borderRadius:11,background:`${T.red}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,flexShrink:0}}>üö™</div>
                    <div style={{flex:1}}>
                      <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:13,color:T.red,marginBottom:2}}>Log Out</div>
                      <div style={{fontSize:11,color:T.sec}}>Sign out of your account</div>
                    </div>
                    <span style={{color:T.red,fontSize:14}}>‚Ä∫</span>
                  </div>
                </div>

                <div style={{textAlign:'center',fontSize:11,color:T.muted,marginTop:20,paddingBottom:8}}>
                  nutriAI v1.0.0 ¬∑ Build 42
                </div>
              </div>
            </>
          )}

          {/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              ‚óà  STATS
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
          {screen === 'stats' && (
            <>
              <div style={{padding:'50px 20px 0',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}} className="a1">
                <div>
                  <div style={{fontSize:11,color:T.sec,fontWeight:700,letterSpacing:'.5px',textTransform:'uppercase',marginBottom:4}}>nutriAI</div>
                  <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:24,letterSpacing:'-.7px'}}>Progress & Stats</div>
                </div>
                <div style={{display:'flex',gap:8,alignItems:'center'}}>
                  <div style={{display:'flex',alignItems:'center',gap:6,fontSize:11,color:T.sec}}>
                    <span>Demo empty</span>
                    <div onClick={()=>setShowEmptyDemo(v=>!v)} style={{width:38,height:20,borderRadius:10,background:showEmptyDemo?T.lime:T.surf3,position:'relative',cursor:'pointer',transition:'background .2s',border:`1px solid ${T.bdr2}`}}>
                      <div style={{width:14,height:14,borderRadius:'50%',background:showEmptyDemo?'#07070c':T.sec,position:'absolute',top:2,left:showEmptyDemo?21:2,transition:'left .2s'}}/>
                    </div>
                  </div>
                  <div className="ib" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</div>
                </div>
              </div>

              {/* Sub tabs */}
              <div className="stabs a2">
                {[{id:'weight',icon:'‚öñÔ∏è',label:'Weight'},{id:'macros',icon:'ü•©',label:'Macros'},{id:'streak',icon:'üî•',label:'Streak'},{id:'ai',icon:'‚ú¶',label:'AI Report'}].map(t=>(
                  <div key={t.id} className={`stab ${statsTab===t.id?'active':''}`} onClick={()=>setStTab(t.id)}>
                    {t.icon} {t.label}
                  </div>
                ))}
              </div>

              {/* ‚îÄ‚îÄ Weight ‚îÄ‚îÄ */}
              {statsTab==='weight' && (
                <>
                  <div className="sec a3">
                    <div className="card cp">
                      <div style={{display:'flex',alignItems:'center',gap:18,marginBottom:18}}>
                        <div style={{flex:1}}>
                          <div style={{fontSize:10,color:T.muted,textTransform:'uppercase',letterSpacing:'.6px',fontWeight:800,marginBottom:8}}>Total Change</div>
                          <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:42,letterSpacing:-2,lineHeight:1,color:showEmptyDemo?T.muted:wProg.delta<=0?T.green:T.orange}}>{showEmptyDemo?'‚Äî':wProg.deltaStr}</div>
                          <div style={{fontSize:12,color:T.sec,marginTop:8}}>{showEmptyDemo?txt.startLogging:`${Math.abs(wProg.toGoal).toFixed(1)}kg to ${user.goal_type==='lose'?'lose':'gain'} ¬∑ Goal: ${user.targetWeightKg}kg`}</div>
                        </div>
                        <div style={{textAlign:'center'}}>
                          <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:28,color:showEmptyDemo?T.muted:T.lime,letterSpacing:-1}}>{showEmptyDemo?'0':wProg.pct}%</div>
                          <div style={{fontSize:9,color:T.muted,textTransform:'uppercase',letterSpacing:'.5px',fontWeight:800,marginBottom:8}}>to goal</div>
                          <div style={{height:4,width:80,background:T.surf3,borderRadius:2,overflow:'hidden'}}>
                            <div style={{height:'100%',width:`${showEmptyDemo?0:wProg.pct}%`,background:T.lime,borderRadius:2,transition:'width 1.2s'}}/>
                          </div>
                        </div>
                      </div>
                      <div className="ptabs">
                        {['week','month','all'].map(p=>(
                          <div key={p} className={`ptab ${chartPeriod===p?'active':''}`} onClick={()=>setChartPeriod(p)}>
                            {p==='week'?'7 Days':p==='month'?'30 Days':'All Time'}
                          </div>
                        ))}
                      </div>
                      <LineChart key={chartPeriod+showEmptyDemo} data={chartData} color={T.lime} unit="kg" goalVal={user.targetWeightKg} isEmpty={showEmptyDemo} W={370} H={150}/>
                    </div>
                  </div>
                  <div className="sec a4">
                    <div className="sechd"><div className="sectitle">Calorie History</div><div className="secact">7 days</div></div>
                    <div className="card cp">
                      <LineChart key={'cal'+showEmptyDemo} data={calChartData} color={T.teal} unit=" kcal" goalVal={user.calorie_target} isEmpty={showEmptyDemo} W={370} H={130}/>
                      <div style={{display:'flex',gap:8,marginTop:14,paddingTop:14,borderTop:`1px solid ${T.bdr}`}}>
                        {[
                          {l:'Avg/day',v:showEmptyDemo?'0':stats.weeklyAvg,c:T.text},
                          {l:'On target',v:showEmptyDemo?'0/7':`${stats.daysOnTarget}/7`,c:T.lime},
                          {l:'Completion',v:showEmptyDemo?'0%':`${stats.weekCompletion}%`,c:stats.weekCompletion>=70?T.green:T.orange},
                        ].map(s=>(
                          <div key={s.l} style={{flex:1,textAlign:'center',background:T.surf2,borderRadius:12,padding:'11px 6px',border:`1px solid ${T.bdr}`}}>
                            <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:16,letterSpacing:'-.5px',color:s.c}}>{s.v}</div>
                            <div style={{fontSize:9,color:T.muted,textTransform:'uppercase',letterSpacing:'.5px',fontWeight:700,marginTop:4}}>{s.l}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </>
              )}

              {/* ‚îÄ‚îÄ Macros ‚îÄ‚îÄ */}
              {statsTab==='macros' && (
                <>
                  <div className="sec a3">
                    {!showEmptyDemo && user.plan==='pro' ? (
                      <div className="card cp">
                        <div style={{display:'flex',gap:20,alignItems:'center',marginBottom:18}}>
                          <ScoreRing score={stats.adherenceScore} size={116} T={T}/>
                          <div style={{flex:1}}>
                            <div style={{fontSize:10,color:T.muted,textTransform:'uppercase',letterSpacing:'.6px',fontWeight:800,marginBottom:6}}>Macro Adherence Score</div>
                            <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:14,marginBottom:6}}>{stats.adherenceScore>=85?'üèÜ Excellent':stats.adherenceScore>=65?'‚ú® Good':stats.adherenceScore>=45?'üìà Improving':'üéØ Keep going'}</div>
                            <div style={{fontSize:11,color:T.sec,lineHeight:1.65}}>14-day average. Protein weighted 45%, carbs 30%, fat 25%.</div>
                          </div>
                        </div>
                        {[
                          {ico:'ü•©',nm:'Protein',pct:stats.proteinAdh,color:T.teal,  target:user.protein_target,days:Math.round(stats.proteinAdh/100*14)},
                          {ico:'üåæ',nm:'Carbs',  pct:stats.carbAdh,   color:T.orange,target:user.carb_target,   days:Math.round(stats.carbAdh/100*14)},
                          {ico:'ü•ë',nm:'Fat',    pct:stats.fatAdh,    color:T.pink,  target:user.fat_target,    days:Math.round(stats.fatAdh/100*14)},
                        ].map((m,i)=>(
                          <div key={m.nm} className="abar-row">
                            <div className="abar-ico" style={{background:m.color+'18'}}>{m.ico}</div>
                            <div className="abar-inf">
                              <div className="abar-nm">{m.nm} <span style={{fontSize:10,color:T.muted,fontWeight:400}}>target {m.target}g</span></div>
                              <ABar pct={m.pct} color={m.color} delay={i*110} h={6}/>
                            </div>
                            <div className="abar-r">
                              <div className="abar-pct" style={{color:m.color}}>{m.pct}%</div>
                              <div className="abar-d">{m.days}/14 days</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : showEmptyDemo ? (
                      <div className="card cp"><div className="cempty"><div className="ce-ico">ü•©</div><div className="ce-ttl">No data yet</div><div className="ce-sub">{txt.startLogging}</div></div></div>
                    ) : (
                      <div className="progate">
                        <div className="pg-ico">üìä</div>
                        <div className="pg-inf"><div className="pg-ttl">Advanced Macro Analytics</div><div className="pg-sub">Adherence scoring, trend predictions on Pro.</div></div>
                        <button className="pg-btn" onClick={()=>showToast('üöÄ Upgrade!')}>Go Pro</button>
                      </div>
                    )}
                  </div>
                  <div className="sec a4">
                    <div className="sechd"><div className="sectitle">Weekly Overview</div></div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                      {[
                        {ico:'üî•',val:showEmptyDemo?'‚Äî':stats.weeklyAvg,lbl:'Avg Calories/day',c:T.lime,glow:T.limeG},
                        {ico:'üìÖ',val:showEmptyDemo?'0/7':`${stats.daysOnTarget}/7`,lbl:'Days On Target',c:T.teal,glow:T.tealDim},
                        {ico:'üìä',val:showEmptyDemo?'0%':`${stats.weekCompletion}%`,lbl:'Completion Rate',c:T.violet,glow:T.violetDim},
                        {ico:'ü•©',val:showEmptyDemo?'0%':`${stats.proteinAdh}%`,lbl:'Protein Hit Rate',c:T.orange,glow:T.orangeDim},
                      ].map(c=>(
                        <div key={c.lbl} className="ccell">
                          <div className="ccell-glow" style={{background:c.glow}}/>
                          <div className="cc-ico">{c.ico}</div>
                          <div className="cc-val" style={{color:c.c}}>{c.val}</div>
                          <div className="cc-lbl">{c.lbl}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </>
              )}

              {/* ‚îÄ‚îÄ Streak ‚îÄ‚îÄ */}
              {statsTab==='streak' && (
                <>
                  <div className="sec a3">
                    <div style={{display:'flex',gap:8,marginBottom:14}}>
                      {[
                        {ico:'üî•',val:showEmptyDemo?0:user.streak,lbl:'Current Streak',c:T.orange},
                        {ico:'üèÜ',val:showEmptyDemo?0:user.longestStreak,lbl:'Longest',c:T.lime},
                        {ico:'üìÖ',val:showEmptyDemo?'0%':`${stats.weekCompletion}%`,lbl:'This Week',c:T.teal},
                      ].map(s=>(
                        <div key={s.lbl} className="skpi">
                          <div className="skpi-ico">{s.ico}</div>
                          <div className="skpi-val" style={{color:s.c}}>{s.val}</div>
                          <div className="skpi-lbl">{s.lbl}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="sec a4">
                    <div className="sechd"><div className="sectitle">35-Day Heatmap</div></div>
                    <div className="card cp">
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                        <div style={{fontSize:11,color:T.sec}}>Daily calorie target adherence</div>
                        <div style={{display:'flex',gap:7,fontSize:9,color:T.muted}}>
                          {[[T.lime,'Hit'],[T.limeG.replace('.18','.5'),'~'],[T.surf3,'Miss']].map(([c,l])=>(
                            <span key={l} style={{display:'flex',alignItems:'center',gap:3}}>
                              <span style={{width:9,height:9,borderRadius:2,background:c,display:'inline-block'}}/>
                              {l}
                            </span>
                          ))}
                        </div>
                      </div>
                      <div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:4,marginBottom:6}}>
                        {'MTWTFSS'.split('').map((d,i)=><div key={i} style={{textAlign:'center',fontSize:9,color:T.muted,fontWeight:700}}>{d}</div>)}
                      </div>
                      {showEmptyDemo
                        ? <div className="cempty"><div className="ce-ico">üìÜ</div><div className="ce-ttl">No data yet</div><div className="ce-sub">{txt.startLogging}</div></div>
                        : <StreakCal dailyLogs={dailyLogs} target={user.calorie_target}/>
                      }
                    </div>
                  </div>
                  {!showEmptyDemo && (
                    <div className="sec a5" style={{paddingBottom:4}}>
                      <div style={{background:user.streak>=7?`linear-gradient(135deg,#1c0e02,#0a0a1a)`:T.surf2,border:`1px solid ${T.orange}22`,borderRadius:26,padding:20,position:'relative',overflow:'hidden'}}>
                        <div style={{position:'absolute',top:-40,right:-40,width:140,height:140,background:`radial-gradient(circle,${T.orangeDim},transparent 70%)`,pointerEvents:'none'}}/>
                        <div style={{fontSize:32,marginBottom:12}}>üî•</div>
                        <div style={{fontFamily:'var(--fh)',fontWeight:900,fontSize:20,letterSpacing:'-.6px',marginBottom:8}}>{user.streak>=7?`${user.streak}-day fire!`:'Build your streak'}</div>
                        <div style={{fontSize:13,color:T.sec,lineHeight:1.7,marginBottom:18}}>{user.streak>=7?`${user.streak} days straight. Top 12% of users. Best: ${user.longestStreak} days.`:'Log meals daily to ignite your streak. Even 3 days builds momentum.'}</div>
                        <div style={{display:'flex',gap:6}}>
                          {Array.from({length:7},(_,i)=>(
                            <div key={i} style={{flex:1,height:34,borderRadius:8,background:i<user.streak%7?T.orange:T.surf3,display:'flex',alignItems:'center',justifyContent:'center',fontSize:13,transition:`background .3s ${i*.07}s`}}>
                              {i<user.streak%7?'üî•':''}
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                </>
              )}

              {/* ‚îÄ‚îÄ AI Report ‚îÄ‚îÄ */}
              {statsTab==='ai' && (
                <div className="sec a3">
                  {showEmptyDemo ? (
                    <div className="card cp"><div className="cempty"><div className="ce-ico">‚ú¶</div><div className="ce-ttl">AI insights locked</div><div className="ce-sub">{txt.startLogging}</div></div></div>
                  ) : user.plan!=='pro' ? (
                    <div>
                      <div className="progate" style={{marginBottom:14}}>
                        <div className="pg-ico">‚ú¶</div>
                        <div className="pg-inf"><div className="pg-ttl">AI Progress Summaries</div><div className="pg-sub">Weekly AI analysis, trend predictions & personalized reports.</div></div>
                        <button className="pg-btn" onClick={()=>showToast('üöÄ Upgrade!')}>Go Pro</button>
                      </div>
                      <div style={{position:'relative'}}>
                        <div style={{filter:'blur(5px)',pointerEvents:'none'}}>
                          <div className="aicard"><div className="aibody">{[1,2,3,4].map(i=><div key={i} className="ai-item"><div className="ai-ico" style={{background:T.limeDim}}>‚ú¶</div><div className="ai-txt">Personalized insight #{i} appears here with data-driven analysis‚Ä¶</div></div>)}</div></div>
                        </div>
                        <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center'}}>
                          <div style={{background:T.surf,border:`1px solid ${T.violet}40`,borderRadius:18,padding:'16px 22px',textAlign:'center',boxShadow:'0 8px 32px rgba(0,0,0,.6)'}}>
                            <div style={{fontSize:28,marginBottom:8}}>üîí</div>
                            <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:15,marginBottom:3}}>Pro Feature</div>
                            <div style={{fontSize:12,color:T.sec}}>Upgrade to unlock</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div>
                      <div className="aicard">
                        <div className="aicard-orb1"/><div className="aicard-orb2"/>
                        <div className="aihdr">
                          <div className="aiorb">‚ú¶</div>
                          <div>
                            <div className="ai-bdg">AI Progress Report ¬∑ {aiReport?.period||'Analyzing‚Ä¶'}</div>
                            <div className="ai-sub">{aiReportLoad?'Generating your personalized analysis‚Ä¶':aiReport?.summary_title||'Powered by Claude AI'}</div>
                          </div>
                        </div>
                        {aiReportLoad ? (
                          <div className="ai-load"><div className="ai-spinner"/><div style={{fontSize:13,color:T.sec,fontWeight:500}}>Claude is analyzing 6 weeks of data‚Ä¶</div></div>
                        ) : aiReport ? (
                          <div className="aibody">
                            {aiReport.insights.map((ins,i)=>{
                              const bg={progress:T.limeDim,nutrition:T.tealDim,streak:T.orangeDim,tip:T.violetDim}[ins.type]||T.limeDim;
                              return <div key={i} className="ai-item"><div className="ai-ico" style={{background:bg}}>{ins.icon}</div><div className="ai-txt" dangerouslySetInnerHTML={{__html:ins.text}}/></div>;
                            })}
                          </div>
                        ) : null}
                        {!aiReportLoad && aiReport && (
                          <div style={{padding:'0 18px 18px',display:'flex',gap:8}}>
                            <button className="btn-ghost" style={{flex:1,fontSize:12,padding:'10px'}} onClick={()=>{setAiReport(null);setAiReportLoad(true);getAISummary(user,weightLogs,dailyLogs).then(d=>{setAiReport(d);setAiReportLoad(false);})}}>‚Ü∫ Refresh</button>
                            <button className="btn-ghost" style={{flex:1,fontSize:12,padding:'10px'}} onClick={()=>showToast('üìÑ Export ‚Äî coming soon')}>üì§ Export PDF</button>
                          </div>
                        )}
                      </div>
                      {aiReport && (
                        <div style={{marginTop:14,background:T.surf,border:`1px solid ${T.bdr}`,borderRadius:24,padding:18}}>
                          <div style={{fontFamily:'var(--fh)',fontWeight:800,fontSize:14,marginBottom:12}}>Body Change Summary</div>
                          {[
                            {lbl:'Weight change',val:`${wProg.deltaStr} in 6 weeks`,pos:user.goal_type==='lose'?wProg.delta<0:wProg.delta>0},
                            {lbl:'Goal progress',val:`${wProg.pct}% to target`,pos:true},
                            {lbl:'Protein consistency',val:`${stats.proteinAdh}% avg adherence`,pos:stats.proteinAdh>=75},
                            {lbl:'Days on target',val:`${stats.daysOnTarget}/7 this week`,pos:stats.daysOnTarget>=5},
                          ].map((s,i)=>(
                            <div key={i} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'9px 0',borderBottom:i<3?`1px solid ${T.bdr}`:'none'}}>
                              <div style={{fontSize:12,color:T.sec}}>{s.lbl}</div>
                              <div style={{fontSize:12,fontWeight:700,color:s.pos?T.green:T.orange}}>{s.val}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </>
          )}

          <div style={{height:20}}/>
        </div>{/* /scroll */}

        {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            BOTTOM NAV + FAB
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
        <div className="fabwrap">
          <div className="bnav">
            {[
              {id:'home',   i:'‚¨°', l:txt.home},
              {id:'ideas',  i:'‚ú¶', l:txt.ideas},
              {id:'fab', fab:true},
              {id:'stats',  i:'‚óà', l:txt.stats},
              {id:'profile',i:'‚óâ', l:txt.profile},
            ].map(n => n.fab
              ? <div key="fp" style={{width:56}}/>
              : (
                <div key={n.id} className={`nit ${screen===n.id?'active':''}`} onClick={()=>goTo(n.id)}>
                  <div className="ni">{n.i}</div>
                  <div className="nl">{n.l}</div>
                </div>
              )
            )}
          </div>
          <div className="fab" onClick={()=>setScanOpen(true)}>üì∏</div>
        </div>
      </div>
    </>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BACKEND REFERENCE & INTEGRATION CHECKLIST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

   ‚îÄ‚îÄ INTEGRATION CONFIRMATION CHECKLIST ‚îÄ‚îÄ
   [‚úì] Dashboard connected to shared user state (calorie_target, macros, streak)
   [‚úì] Dashboard updates instantly when meal scanned (optimistic state update)
   [‚úì] Stats reflect new data (dailyLogs shared in global state)
   [‚úì] Profile recalculations (BMR/TDEE) update dashboard targets live
   [‚úì] No duplicated logic ‚Äî all utils in ¬ß2, all state in ¬ß11
   [‚úì] No broken imports ‚Äî single-file component
   [‚úì] Zero-state safe ‚Äî all values default to 0, no null errors
   [‚úì] Charts receive isEmpty prop ‚Äî show motivational empty state
   [‚úì] Scan modal integrates with dashboard meal list
   [‚úì] Meal Ideas reads remaining macros from shared state
   [‚úì] Ideas limit enforced (1/day free, unlimited pro)
   [‚úì] Profile edit modal updates user + recalculates dashboard targets
   [‚úì] Weight log updates user.weightKg + recalculates all targets
   [‚úì] Stats charts get chartData slices from shared weightLogs/dailyLogs
   [‚úì] AI Report (Stats) uses same getAISummary() from ¬ß8
   [‚úì] AI Meal Ideas uses generateMealIdeas() from ¬ß8
   [‚úì] Theme toggle applied globally via makeCSS(T)
   [‚úì] Language switcher applied globally via I18N[lang]
   [‚úì] Dark + Light mode both fully functional
   [‚úì] All 5 nav destinations wired: home, ideas, stats, profile, FAB

   ‚îÄ‚îÄ BACKEND ENDPOINTS ‚îÄ‚îÄ

   GET  /api/v1/dashboard?date=YYYY-MM-DD&timezone=TZ
   ‚Üí Returns: { user, daily: {consumed,protein,carbs,fat,meals[]}, streak }
   -- Zero-safe: COALESCE(SUM(mi.calories), 0) for empty days

   POST /api/v1/meals/items
   Body: { meal_type, name, calories, protein_g, carbs_g, fat_g, confidence }
   ‚Üí Returns: { meal_item, updated_daily_totals }

   POST /api/v1/weight-logs
   Body: { weight_kg }
   ‚Üí Returns: { weight_log, recalculated: { bmr, tdee, calorie_target, ...macros } }

   GET  /api/v1/stats/overview
   ‚Üí Returns: { weightLogs[], dailyLogs[], streakData, adherenceScore }

   POST /api/v1/meal-ideas/generate  [Pro: unlimited | Free: 1/day]
   Body: { remaining_macros, goal_type, diet }
   ‚Üí Returns: { ideas[] } or 429 { error: 'daily_limit_reached' }

   GET  /api/v1/stats/ai-summary  [Pro only ‚Üí 403 if free]
   ‚Üí Returns: { summary_title, period, insights[] }

   PUT  /api/v1/users/profile
   Body: { name, age, gender, heightCm, weightKg, goal_type, activity, diet }
   ‚Üí Returns: { user, recalculated_targets }

   ‚îÄ‚îÄ DATABASE TABLES (null-safe) ‚îÄ‚îÄ

   meal_ideas_logs (
     id UUID PK DEFAULT gen_random_uuid(),
     user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     date DATE NOT NULL DEFAULT CURRENT_DATE,
     macros_remaining JSONB NOT NULL,
     generated_output JSONB NOT NULL,
     plan_type TEXT NOT NULL DEFAULT 'free',
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   CREATE UNIQUE INDEX ON meal_ideas_logs(user_id, date) WHERE plan_type = 'free';

   SELECT COUNT(*) FROM meal_ideas_logs
   WHERE user_id = $1 AND date = CURRENT_DATE AND plan_type = 'free';
   -- If >= 1 ‚Üí return 429

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
